<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Respira ‚Ä¢ Tu Espacio de Calma</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="theme-color" content="#eefcfd">
    <meta name="description" content="Una aplicaci√≥n minimalista para respirar, relajarse y leer.">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;700&family=Manrope:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        /* --- 1. BASE VARIABLES --- */
        :root {
            --dune-light: #eefcfd;
            --dune-mid: #e0f7fa;
            --text-main: #37474f;
            --text-muted: #78909c;
            --primary: #4CAF50;
            --accent: #00838f;
            --substack-orange: #FF6719;
            --organic-blue: #80deea;
            --organic-gold: #fff9c4;
            --bg-zen: #e0f2f1;
            --c-inhale: #81c784;
            --c-inhale: #4CAF50;
            --c-hold: #FF9800;
            --c-exhale: #2196F3;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

                body {
            margin: 0;
            padding: 0;
            font-family: 'Manrope', sans-serif;
            color: var(--text-main);
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            /* Fondo ZEN sutil - tonos pastel suaves */
            background: linear-gradient(135deg, #f5f9f9 0%, #e8f4f5 50%, #f0f7f8 100%);
            background-size: 200% 200%;
            animation: organicGradient 20s ease infinite;
        }


        /* Animaci√≥n del fondo */
        @keyframes organicGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- 2. LAYOUT GENERAL CORREGIDO --- */
        .app-layout {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            /* --- CAMBIO CR√çTICO --- Elevamos toda la app al piso 2 para que NADA la tape */
            position: relative;
            z-index: 2;
        }

        .top-bar {
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            z-index: 50; /* Esto se mantiene encima del resto de la app */
            height: 70px;
        }

        .top-left, .top-right {
            pointer-events: auto;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .badge {
            background: rgba(255,255,255,0.6);
            backdrop-filter: blur(10px);
            color: var(--accent);
            border: 1px solid rgba(255,255,255,0.4);
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .btn-icon {
            background: rgba(255,255,255,0.5);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.3);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            color: var(--text-main);
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .btn-icon:hover {
            background: rgba(255,255,255,0.9);
            transform: translateY(-2px);
        }

        .btn-icon:active {
            transform: scale(0.95);
        }

        /* V1.3.0 Estado ACTIVO para botones toggle Metronomo y Frases */
        .btn-icon.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(0, 131, 143, 0.4);
        }

        .btn-text {
            background: rgba(255,255,255,0.5);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 20px;
            border-radius: 30px;
            color: var(--text-main);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Manrope', sans-serif;
        }

        /* --- 3. ESCENARIO CENTRAL --- */
        .stage-container {
            flex: 1;
            display: flex;
            width: 100%;
            position: relative;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 10px 0;
        }

        .panel-side {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            width: 100%;
            min-height: 90px;
        }

        .panel-center {
            position: relative;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 60px 0;
            flex-shrink: 0;
        }

        .phase-text {
            font-family: 'Cinzel', serif;
            font-size: clamp(2.5rem, 6vw, 4rem);
            font-weight: 400;
            letter-spacing: 2px;
            color: var(--accent);
            text-transform: uppercase;
            text-align: center;
            white-space: nowrap;
            transition: color 0.5s ease;
            text-shadow: 0 10px 30px rgba(168, 206, 212, 0.4);
            z-index: 30;
            margin-bottom: 5px;
        }

        .mode-indicator {
            margin-top: 10px;
            font-size: 2.5rem;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.5s ease;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
            z-index: 50;
        }

        .mode-indicator.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .quote {
            padding: 0 25px;
            color: var(--text-muted);
            font-family: 'Cinzel', serif;
            font-size: 1.15rem;
            text-align: center;
            max-width: 500px;
            line-height: 1.6;
            z-index: 30;
            margin-top: 10px;
            /* V1.3.0 Altura m√≠nima para evitar saltos y transici√≥n suave */
            min-height: 2em;
            transition: opacity 0.6s ease;
        }

        .sphere-wrapper {
            position: relative;
            width: min(50vw, 260px);
            height: min(50vw, 260px);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

       .sphere {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.95), var(--c-phase));
            box-shadow: 
                0 20px 70px var(--c-phase),
                inset 0 0 20px rgba(255,255,255,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            
            /* Esto mejora el rendimiento pero NO anima el movimiento */
            will-change: transform, background;
            transform: scale(0.8); 
            
            /* --- CORRECCI√ìN CR√çTICA --- */
            /* SOLO animamos el color y la sombra. */
            /* ELIMINAMOS 'transform' de aqu√≠ para que el JS tenga el control total */
            transition: background 0.1s linear, box-shadow 0.1s linear;
        }

        .counter-big {
            font-family: 'Manrope', sans-serif;
            font-size: 4rem;
            font-weight: 800;
            color: white;
            text-shadow: 0 2px 15px rgba(0,0,0,0.15);
            line-height: 1;
        }

        .sphere-label {
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            z-index: 25;
        }

        .p-num {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.6);
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-block;
        }

        .p-mode-sub {
            font-size: 0.6em;
            vertical-align: super;
            opacity: 0.8;
            margin-left:1px;
        }

        .p-sep {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.4);
        }

        .p-num.active {
            color: #fff;
            font-weight: 800;
            transform: scale(1.4);
            text-shadow: 0 0 12px rgba(255,255,255,1);
        }

        /* --- 4. VISUALIZADOR --- */
        .bottom-viz {
            flex-shrink: 0;
            width: 100%;
            height: 90px;
            margin: 0 auto 4vh auto;
            position: relative;
            z-index: 15;
            -webkit-mask-image: linear-gradient(to right, transparent 0%, black 20%, black 80%, transparent 100%);
            mask-image: linear-gradient(to right, transparent 0%, black 20%, black 80%, transparent 100%);
        }

        #breathGraph {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* --- 5. MEN√ö SELECCI√ìN --- */
        #selectionMenu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(238, 252, 253, 0.95);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
            transition: opacity 0.4s ease;
        }

        /* --- LUCES Estacional --- */
        .navidad-lights {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            pointer-events: none;
            z-index: 120;
        }

        .light {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: breath-light 4s infinite ease-in-out;
        }

        .light.red {
            background: #ff4d4d;
            box-shadow: 0 0 12px #ff4d4d;
            animation-delay: 0s;
        }

        .light.green {
            background: #2ecc71;
            box-shadow: 0 0 12px #2ecc71;
            animation-delay: 1.3s;
        }

        .light.blue {
            background: #4facfe;
            box-shadow: 0 0 12px #4facfe;
            animation-delay: 2.6s;
        }

        @keyframes breath-light {
            0%, 100% {
                opacity: 0.2;
                transform: scale(0.8);
            }
            50% {
                opacity: 1;
                transform: scale(1.15);
                box-shadow: 0 0 20px currentColor;
            }
        }

        /* --- BOTONES Y TEXTOS --- */
        .global-info-btn {
            position: absolute;
            top: 30px;
            right: 30px;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: rgba(255,255,255,0.9);
            border: 1px solid rgba(76, 175, 80, 0.3);
            color: var(--primary);
            font-family: 'Manrope', sans-serif;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.15);
            transition: all 0.3s ease;
            z-index: 110;
        }

        .global-info-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
        }

        .menu-title {
            font-family: 'Cinzel', serif;
            font-size: 2.2rem;
            color: #263238;
            margin-bottom: 30px;
            letter-spacing: 0.1em;
            font-weight: 500;
            text-align: center;
            background: -webkit-linear-gradient(45deg, #263238, #546e7a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .menu-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            width: 100%;
            justify-content: center;
        }

        .action-btn {
            background: white;
            border: 1px solid rgba(0,0,0,0.05);
            padding: 12px 20px;
            border-radius: 30px;
            color: var(--accent);
            font-weight: 600;
            font-size: 0.9rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .menu-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            width: 100%;
            max-width: 450px;
            max-height: 55vh;
            overflow-y: auto;
            padding: 5px;
        }

        /* --- TARJETAS --- */
        .menu-card {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 16px;
            cursor: pointer;
            text-align: left;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 10px rgba(178, 235, 242, 0.1);
            position: relative;
        }

        .menu-card:hover {
            transform: translateY(-3px) scale(1.01);
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 10px 25px rgba(178, 235, 242, 0.3);
        }

        .menu-card h3 {
            color: #37474f;
            font-size: 1.1rem;
            margin-bottom: 4px;
            font-weight: 700;
            font-family: 'Manrope', sans-serif;
        }

        .menu-card p {
            color: #78909c;
            font-size: 0.9rem;
            font-weight: 400;
        }

        .menu-card.custom-card {
            border: 2px dashed rgba(0, 131, 143, 0.3);
            background: rgba(255, 255, 255, 0.4);
        }

        .menu-card.custom-card h3 {
            color: var(--accent);
        }

        /* --- SUBSTACK CARD PRO --- */
        .substack-card {
            background: linear-gradient(135deg, #FFFFFF 0%, #F0FFF4 50%, #E0F2F1 100%);
            border: 1px solid rgba(255, 103, 25, 0.15);
            border-radius: 16px;
            padding: 25px 22px;
            min-height: 100px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(200, 230, 201, 0.4);
            transition: all 0.4s ease;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            gap: 15px;
            flex-wrap: nowrap;
        }

        .substack-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, transparent 70%);
            opacity: 0.6;
            pointer-events: none;
            transform: rotate(30deg);
        }

        .substack-card:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 30px rgba(200, 230, 201, 0.6), 0 0 10px rgba(255, 103, 25, 0.1);
        }

        .substack-icon {
            width: 42px;
            height: 42px;
            flex-shrink: 0;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            z-index: 2;
        }

        .substack-content {
            z-index: 2;
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .substack-label {
            font-family: 'Manrope', sans-serif;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #78909c;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .substack-title {
            font-family: 'Cinzel', serif;
            font-weight: 700;
            font-size: 1.2rem;
            color: #263238;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        .substack-author {
            font-family: 'Manrope', sans-serif;
            font-size: 0.9rem;
            color: var(--substack-orange);
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- OVERLAYS --- */
        #customOverlay, #shareConfigOverlay, #guideOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.98);
            z-index: 150;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 15vh;
            overflow-y: auto;
            backdrop-filter: blur(15px);
            text-align: center;
        }

        .overlay-title {
            font-family:'Cinzel';
            color:var(--text-main);
            margin-bottom:10px;
            font-size: 1.5rem;
        }

        .overlay-subtitle {
            color:var(--text-muted);
            margin-bottom:30px;
            font-size: 0.95rem;
        }

        .custom-input-container {
            position: relative;
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .big-input {
            font-size: 2.8rem;
            font-family: 'Manrope', sans-serif;
            font-weight: 300;
            border: none;
            border-bottom: 2px solid var(--accent);
            background: transparent;
            color: var(--text-main);
            width: 320px;
            text-align: center;
            letter-spacing: 2px;
            outline: none;
            padding-bottom: 5px;
            border-radius: 0;
        }

        .normal-input {
            width: 80%;
            max-width: 300px;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #cfd8dc;
            border-radius: 10px;
            font-family: 'Manrope', sans-serif;
            font-size: 1rem;
            color: var(--text-main);
            background: #fcfcfc;
            outline: none;
            text-align: center;
        }

        .normal-input:focus {
            border-color: var(--accent);
            background: white;
        }

        .info-bubble {
            width: 32px;
            height: 32px;
            background: var(--text-muted);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin-left: 15px;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* TOOLTIP DE AYUDA Estilo Burbuja */
        .info-tooltip {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-85%);
            width: 290px;
            background: #37474f;
            color: white;
            padding: 20px;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.6;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 200;
            text-align: left;
        }

        .info-tooltip.visible {
            opacity: 1;
            visibility: visible;
        }

        .info-tooltip::before {
            content: '';
            position: absolute;
            top: -6px;
            right: 20%;
            border-width: 6px;
            border-style: solid;
            border-color: transparent transparent #37474f transparent;
        }

        /* FIX UX Close button for tooltip */
        .close-tooltip {
            float: right;
            font-size: 1.2rem;
            cursor: pointer;
            color: #cfd8dc;
            margin: -10px -5px 0 0;
            font-weight: 300;
        }

        .close-tooltip:hover {
            color: white;
        }

        /* GUIA ICONOS CARD */
        .guide-card {
            background: white;
            border:1px solid #eee;
            border-radius: 16px;
            padding: 30px;
            max-width: 90%;
            width: 350px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            text-align: left;
        }

        .guide-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
            font-size: 1rem;
            color: #546e7a;
        }

        .guide-icon {
            width: 30px;
            text-align: center;
            font-size: 1.4rem;
        }

        /* REFUGIO/SUBSTACK OVERLAY M√ìVIL VERTICAL Dise√±o original aireado */
        .refugio-card {
            background: white;
            border: 1px solid #EEE;
            border-radius: 16px;
            max-width: 380px;
            width: 90%;
            padding: 30px 30px 45px 30px; /* Aire original */
            box-shadow: 0 20px 60px rgba(0,0,0,0.08);
            text-align: center;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .refugio-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--substack-orange);
        }

        .refugio-title {
            font-family: 'Cinzel', serif;
            font-size: 1.6rem;
            color: #2c2c2c;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .refugio-author {
            font-family: 'Manrope', sans-serif;
            font-size: 0.95rem;
            color: var(--substack-orange);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 25px; /* Aire original */
        }

        .refugio-excerpt {
            font-family: 'Manrope', sans-serif;
            font-size: 1.1rem;
            color: #555;
            line-height: 1.6;
            font-style: italic;
            margin-bottom: 35px; /* Aire original */
        }

        .refugio-btn {
            display: inline-block;
            text-decoration: none;
            background: var(--substack-orange);
            color: white;
            padding: 14px 28px;
            border-radius: 50px;
            font-weight: 700;
            font-family: 'Manrope', sans-serif;
            box-shadow: 0 5px 15px rgba(255, 103, 25, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .refugio-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 103, 25, 0.4);
        }

        /* --- PILL SHARE --- */
        #pillOverlay, #shareModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.95);
            z-index: 200;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 30px;
            backdrop-filter: blur(10px);
        }

        #shareText {
            width: 100%;
            max-width: 400px;
            height: 100px;
            border: 1px solid #cfd8dc;
            border-radius: 12px;
            padding: 15px;
            font-family: 'Manrope', sans-serif;
            font-size: 0.9rem;
            color: #546e7a;
            margin-bottom: 25px;
            background: #fcfcfc;
            resize: none;
            outline: none;
        }

        .share-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn-wa, .btn-copy {
            padding: 14px 28px;
            border-radius: 50px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            color: white;
        }

        .btn-wa {
            background: #25D366;
        }

        .btn-copy {
            background: #546e7a;
        }

        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            z-index: 400;
            backdrop-filter: blur(5px);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0,0,0,0.1);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- MEDIA QUERIES PC FIX --- */
        @media (min-width: 768px), (orientation: landscape) {
            #substackOverlay {
                justify-content: center;
                padding-top: 20px;
            }

            .refugio-card {
                max-width: 500px;
                padding: 25px 40px;
            }

            .refugio-excerpt {
                margin-bottom: 25px;
            }

            .app-layout {
                grid-template-rows: 60px 1fr 80px;
            }

            .stage-container {
                flex-direction: row;
                justify-content: space-around;
                padding: 0 4vw;
            }

            .sphere-wrapper {
                width: 50vh;
                height: 50vh;
            }

            .sphere {
                width: 65%;
                height: 65%;
            }

            .bottom-viz {
                height: 70px;
                width: 80%;
            }

            .menu-grid {
                grid-template-columns: 1fr 1fr;
                max-width: 800px;
                gap:25px;
            }

            #customOverlay, #shareConfigOverlay, #guideOverlay {
                padding-top: 5vh;
                justify-content: center;
            }
        }

        /* --- ADORNOS ORG√ÅNICOS REVISI√ìN FINAL --- */
                .organic-shape {
            position: fixed;
            width: 600px;
            height: 600px;
            border-radius: 50%;
            filter: blur(80px); /* Blur m√°s difuso */
            z-index: 0;
            opacity: 0.15; /* MUY sutil */
            pointer-events: none;
            animation: floatOrganic 25s infinite alternate ease-in-out;
        }

        .shape-1 { /* Azul aguamarina suave */
            background: #b2dfdb;
            top: -150px;
            right: -150px;
        }

        .shape-2 { /* Verde menta suave */
            background: #c8e6c9;
            bottom: -200px;
            left: -150px;
            animation-delay: -8s;
        }


               @keyframes floatOrganic {
            from {
                transform: translate(0, 0) rotate(0deg);
            }
            to {
                transform: translate(60px, 60px) rotate(20deg);
            }
        }
/* --- NUEVO: ESTILOS MODO INVIERNO --- */
    /* 1. El v√≠deo de fondo (invisible por defecto) */
    .video-background {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
        object-fit: cover; /* Cubre toda la pantalla sin deformarse */
        z-index: -1; /* Se queda al fondo */
        opacity: 0; /* Invisible */
        transition: opacity 1.5s ease; /* Transici√≥n muy suave */
        pointer-events: none; /* Los clicks lo atraviesan */
    }

    /* 2. Cuando se activa la clase .winter-mode... */
    .app-layout.winter-mode .video-background {
        opacity: 1; /* ...aparece el v√≠deo */
    }
    
    .app-layout.winter-mode .organic-shape {
        opacity: 0 !important; /* ...y desaparecen las formas de colores */
    }

    /* 3. Ajuste de lectura: Texto blanco con sombra para que destaque sobre la nieve */
    .app-layout.winter-mode .phase-text,
    .app-layout.winter-mode .counter-big,
    .app-layout.winter-mode .sphere-label {
        color: #ffffff !important;
        text-shadow: 0 2px 10px rgba(0,0,0,0.8);
    }
    
    /* Peque√±o detalle: oscurecer un poco la barra superior para que se vean los iconos blancos */
    .app-layout.winter-mode .top-bar button {
        color: white;
        text-shadow: 0 1px 5px rgba(0,0,0,0.5);
    }
    </style>
</head>
<body>

<div class="organic-shape shape-1"></div>
<div class="organic-shape shape-2"></div>

<div id="loadingOverlay">
    <div class="spinner"></div>
    <div style="font-family:'Manrope'; color:#546e7a; font-weight:600;">Preparando...</div>
</div>

<!-- GUIA OVERLAY -->
<div id="guideOverlay">
    <button onclick="document.getElementById('guideOverlay').style.display='none'" style="position:absolute; top:25px; right:25px; background:none; border:none; font-size:2rem; color:#78909c; cursor:pointer; padding:10px; line-height:1; z-index:10;">&times;</button>
    <h2 class="overlay-title">Gu√≠a de Respiraci√≥n</h2>
    <p class="overlay-subtitle">Interpretaci√≥n de s√≠mbolos</p>
    <div class="guide-card">
        <div class="guide-row"><span class="guide-icon" style="color:var(--c-inhale);">‚óè</span><span><strong>Inhala</strong> ‚Äî Verde</span></div>
        <div class="guide-row"><span class="guide-icon" style="color:var(--c-hold);">‚óè</span><span><strong>Pausa/Ret√©n</strong> ‚Äî Naranja</span></div>
        <div class="guide-row"><span class="guide-icon" style="color:var(--c-exhale);">‚óè</span><span><strong>Exhala</strong> ‚Äî Azul</span></div>
        <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
        <div style="font-size:0.9rem; color:#78909c; margin-bottom:10px;">TIP AVANZADO</div>
        <div class="guide-row"><span class="guide-icon">üí®</span><span><strong>Boca</strong> ‚Äî Si ves este icono o a√±ades "b", exhala soplando.</span></div>
    </div>
    <div style="margin-top:40px;">
        <button class="btn-text" style="background:transparent; color:var(--accent); border:1px solid var(--accent);" onclick="document.getElementById('guideOverlay').style.display='none'">Entendido</button>
    </div>
</div>

<!-- SUBSTACK OVERLAY -->
<div id="substackOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.98); z-index:300; display:flex; flex-direction:column; align-items:center; justify-content:center; backdrop-filter:blur(15px); padding:20px 20px 50px 20px; text-align:center; visibility:hidden; opacity:0; pointer-events:none; transition:all 0.4s ease; overflow-y:auto;">
    <button onclick="const el=document.getElementById('substackOverlay'); el.style.opacity='0'; el.style.visibility='hidden'; el.style.pointerEvents='none';" style="position:absolute; top:25px; right:25px; background:none; border:none; font-size:2rem; color:#78909c; cursor:pointer; padding:10px; line-height:1; z-index:10;">&times;</button>
    <h2 style="font-family:'Cinzel'; color:#37474f; margin-bottom:20px; margin-top:40px;">Refugio Po√©tico</h2>
    <div class="refugio-card">
        <div class="refugio-title">Regla de los 10.000 Pies ...</div>
        <div class="refugio-author">by √Ålvaro Garc√≠a</div>
        <div class="refugio-excerpt">JARD√çN MENTAL</div>
        <a href="https://open.substack.com/pub/jardinmental/p/modo-0-1?r=2vlvha&utm_campaign=post&utm_medium=web" target="_blank" rel="noopener noreferrer" class="refugio-btn">
            üìñ Leer en Substack
        </a>
    </div>
    <button class="btn-text" style="margin-top:35px; background:transparent; border:1px solid #cfd8dc; color:#78909c;" onclick="const el = document.getElementById('substackOverlay'); el.style.opacity='0'; el.style.visibility='hidden'; el.style.pointerEvents='none';">
        Volver al Men√∫
    </button>
</div>

<!-- CUSTOM OVERLAY -->
<div id="customOverlay">
    <h2 class="overlay-title">Dise√±a tu Respiraci√≥n</h2>
    <p class="overlay-subtitle">Introduce 4 tiempos<br>A√±ade "b" para boca (ej: "4b")</p>
    <div class="custom-input-container">
        <input type="text" id="customPatternInput" class="big-input" placeholder="4-2-6b-0" maxlength="10" value="">
        <div class="info-bubble" onclick="toggleTooltip(this)">?
            <div class="info-tooltip">
                <span class="close-tooltip" onclick="event.stopPropagation(); this.parentElement.classList.remove('visible');">&times;</span>
                <strong>Escribe los segundos de cada fase.</strong> El sistema pone los guiones.<br><br>
                <span style="color:var(--c-inhale);">1. Inhala ‚Äî Verde</span><br>
                <span style="color:var(--c-hold);">2. Mant√©n ‚Äî Naranja</span><br>
                <span style="color:var(--c-exhale);">3. Exhala ‚Äî Azul</span><br>
                <span style="color:var(--c-hold);">4. Sost√©n ‚Äî Naranja</span><br><br>
                <hr style="border:0; border-top:1px solid rgba(255,255,255,0.2); margin:10px 0;">
                <strong>Opciones Extra</strong><br>
                ‚Ä¢ A√±ade <strong>"b"</strong> para boca (ej: "8b").<br>
                ‚Ä¢ Usa <strong>"0"</strong> para saltar una fase.
            </div>
        </div>
    </div>
    <div style="display:flex; flex-direction:column; gap:15px; margin-bottom: 50px;">
        <button class="btn-text" style="background:var(--primary); color:white; padding:15px 40px; font-size:1.1rem; border:none;" onclick="startCustom()">Comenzar</button>
        <button class="btn-text" style="background:transparent; color:#78909c; border:none;" onclick="document.getElementById('customOverlay').style.display='none'">Cancelar</button>
    </div>
</div>

<!-- SHARE CONFIG OVERLAY -->
<div id="shareConfigOverlay">
    <h2 class="overlay-title">Enviar P√≠ldora</h2>
    <p class="overlay-subtitle">Configura el regalo</p>
    <div class="custom-input-container">
        <input type="text" id="pillPatternInput" class="big-input" placeholder="4-7-8b" maxlength="10" value="">
        <div class="info-bubble" onclick="toggleTooltip(this)">?
            <div class="info-tooltip">
                <span class="close-tooltip" onclick="event.stopPropagation(); this.parentElement.classList.remove('visible');">&times;</span>
                <strong>Escribe los segundos de cada fase.</strong> El sistema pone los guiones.<br><br>
                <span style="color:var(--c-inhale);">1. Inhala ‚Äî Verde</span><br>
                <span style="color:var(--c-hold);">2. Mant√©n ‚Äî Naranja</span><br>
                <span style="color:var(--c-exhale);">3. Exhala ‚Äî Azul</span><br>
                <span style="color:var(--c-hold);">4. Sost√©n ‚Äî Naranja</span><br><br>
                <hr style="border:0; border-top:1px solid rgba(255,255,255,0.2); margin:10px 0;">
                <strong>Opciones Extra</strong><br>
                ‚Ä¢ A√±ade <strong>"b"</strong> para boca (ej: "8b").<br>
                ‚Ä¢ Usa <strong>"0"</strong> para saltar una fase.
            </div>
        </div>
    </div>
    <input type="text" id="pillNameInput" class="normal-input" placeholder="¬øPara qui√©n es?" maxlength="20">
    <input type="text" id="pillMessageInput" class="normal-input" placeholder="Mensaje opcional" maxlength="50">
    <div style="display:flex; flex-direction:column; gap:15px; margin-top:20px; margin-bottom: 50px;">
        <button class="btn-text" style="background:var(--accent); color:white; padding:15px 40px; font-size:1.1rem; border:none;" onclick="generateShareLink()">Generar Enlace</button>
        <button class="btn-text" style="background:transparent; color:#78909c; border:none;" onclick="document.getElementById('shareConfigOverlay').style.display='none'">Cancelar</button>
    </div>
</div>

<!-- SHARE MODAL -->
<div id="shareModal">
    <h2 style="font-family:'Cinzel'; color:#37474f;">¬°P√≠ldora Lista!</h2>
    <textarea id="shareText" readonly></textarea>
    <div class="share-actions">
        <button class="btn-wa" onclick="sendWhatsapp()">üì± WhatsApp</button>
        <button class="btn-copy" onclick="copyToClipboard()">üìã Copiar</button>
    </div>
    <button class="btn-text" style="margin-top:30px; background:transparent; border:none;" onclick="document.getElementById('shareModal').style.display='none'">Cerrar</button>
</div>

<!-- MENU SELECCION -->
<div id="selectionMenu">
    <div class="navidad-lights">
        <div class="light red"></div>
        <div class="light green"></div>
        <div class="light blue"></div>
        <div class="light red"></div>
        <div class="light green"></div>
        <div class="light blue"></div>
        <div class="light red"></div>
        <div class="light green"></div>
        <div class="light blue"></div>
    </div>
    <button class="global-info-btn" onclick="document.getElementById('guideOverlay').style.display='flex'">i</button>
    <div class="menu-title">ELIGE TU RITMO</div>
    <div class="menu-actions">
        <button class="action-btn" onclick="openShareConfig()">
            üéÅ <span>Enviar P√≠ldora</span>
        </button>
        <button class="action-btn" id="installBtn" onclick="installApp()">
            ‚≠ê <span>Instalar App</span>
        </button>
    </div>
    <div class="menu-grid">
        <div class="substack-card" onclick="const el = document.getElementById('substackOverlay'); el.style.visibility='visible'; el.style.opacity='1'; el.style.pointerEvents='auto';">
            <div class="substack-icon">
                <svg viewBox="0 0 24 24" fill="#FF6719" width="20" height="20">
                    <path d="M22.539 8.242H1.46V5.406h21.08v2.836zM1.46 10.812V24L12 18.11 22.54 24V10.812H1.46zM22.54 0H1.46v2.836h21.08V0z"/>
                </svg>
            </div>
            <div class="substack-content">
                <div class="substack-label">Rinc√≥n de Lectura</div>
                <div class="substack-title">Regla de los 10000 Pies ...</div>
                <div class="substack-author">by √Ålvaro Garc√≠at</div>
            </div>
        </div>
        <div class="menu-card custom-card" onclick="openCustomModal()">
            <h3>üé® Crear Personalizado</h3>
            <p>Define tus tiempos (ej: 4-7-8b)</p>
        </div>
        <div class="menu-card" onclick="openSoundscapeSettings()">
          <h3>‚ùÑÔ∏è Paisaje sonoro</h3>
          <p>modo inmersivo</p>
      </div>
        <div class="menu-card" onclick="start('4-4-6-2')">
            <h3>4-4-6-2 ‚Ä¢ Relax Profundo</h3>
            <p>Baja pulsaciones r√°pidamente</p>
        </div>
        <div class="menu-card" onclick="start('4-7-8b')">
            <h3>4-7-8b ‚Ä¢ Relaxing break</h3>
            <p>Rel√°jate </p>
        </div>
        <div class="menu-card" onclick="start('box')">
            <h3>Cuadrada ‚Ä¢ Enfoque</h3>
            <p>Box Breathing (4-4-4-4)</p>
        </div>
        <div class="menu-card" onclick="start('5-5')">
            <h3>5-5 ‚Ä¢ Coherencia</h3>
            <p>Equilibrio total (In 5, Ex 5)</p>
        </div>
    </div>
</div>

<!-- PILL OVERLAY -->
<div id="pillOverlay">
    <h1 style="color:var(--accent); font-family:'Cinzel'; margin-bottom:15px;">Una pausa para ti</h1>
    <h2 id="pillRecipient" style="color:#546e7a; margin-bottom:25px; font-weight:400; font-family:'Manrope';"></h2>
    <p id="pillMessage" style="font-size:1.4rem; font-family:'Cinzel'; color:#37474f; margin-bottom:50px; max-width:600px;"></p>
    <button class="btn-text" style="background:var(--primary); color:white; padding:16px 50px;" onclick="closePill()">Comenzar</button>
</div>

<!-- APP LAYOUT -->
<div class="app-layout">
    <video id="bgVideo" class="video-background" loop playsinline muted>
        <source src="./cielo.mp4" type="video/mp4">
    </video>
    <audio id="winterAudio" loop preload="auto">
        <source src="./clavier_1.mp3" type="audio/mpeg">
    </audio>
    <div class="top-bar">
        <div class="top-left">
            <button class="btn-text" onclick="stop()">‚Üê Men√∫</button>
            <div class="badge" id="cycleBadge">0</div>
        </div>
        <div class="top-right">
            <button class="btn-icon active" id="quoteToggleBtn" onclick="toggleQuotes()">üí¨</button>
            <button class="btn-text" id="tempoBtn" onclick="toggleTempo()">1x</button>
            <button class="btn-icon" id="soundBtn" onclick="toggleSound()">üîî</button>
            <button class="btn-icon" id="musicBtn" onclick="toggleMusic()">üéµ</button>
            <button class="btn-icon" id="metronomeBtn" onclick="toggleMetronome()">‚è±</button>
        </div>
    </div>
    <div style="position: fixed; bottom: 10px; right: 15px; font-size: 0.65rem; color: #90a4ae; opacity: 0.5; z-index: 9999; pointer-events: none; font-family: 'Manrope', sans-serif;">
        Ref <span id="app-version-display">V1.3.0</span>
    </div>
    <div class="stage-container">
        <div class="panel-side">
            <div class="phase-text" id="phaseText">LISTO</div>
            <div class="mode-indicator" id="modeIcon"></div>
        </div>
        <div class="panel-center">
            <div class="sphere-wrapper" onclick="togglePause()" title="Toca para Pausar/Reanudar">
                <div class="sphere" id="sphere">
                    <div class="counter-big" id="counterText"></div>
                    <div class="sphere-label" id="patternDisplay"></div>
                </div>
            </div>
        </div>
        <div class="panel-side">
            <div class="quote" id="phraseContent">Respira...</div>
        </div>
    </div>
    <div class="bottom-viz">
        <canvas id="breathGraph"></canvas>
    </div>
</div>

<script>
    // --- VARIABLES Y CONFIGURACI√ìN ---
    const C_INHALE = '#4CAF50';
    const C_HOLD = '#FF9800';
    const C_EXHALE = '#2196F3';

    // --- AUDIO AMBIENTAL ---
    const ambientAudio = new Audio('ambient.mp3');
    ambientAudio.loop = true;
    ambientAudio.volume = 0.5;

    let patterns = {
        '4-4-6-2': [
            {t:'INHALA', b:4, y:'rise', c:C_INHALE, m:'nose'},
            {t:'MANT√âN', b:4, y:'holdhigh', c:C_HOLD, m:'nose'},
            {t:'EXHALA', b:6, y:'fall', c:C_EXHALE, m:'nose'},
            {t:'SOST√âN', b:2, y:'holdlow', c:C_HOLD, m:'nose'}
        ],
        '4-7-8b': [
            {t:'INHALA', b:4, y:'rise', c:C_INHALE, m:'nose'},
            {t:'MANT√âN', b:7, y:'holdhigh', c:C_HOLD, m:'nose'},
            {t:'EXHALA', b:8, y:'fall', c:C_EXHALE, m:'mouth'}
        ],
        'box': [
            {t:'INHALA', b:4, y:'rise', c:C_INHALE, m:'nose'},
            {t:'MANT√âN', b:4, y:'holdhigh', c:C_HOLD, m:'nose'},
            {t:'EXHALA', b:4, y:'fall', c:C_EXHALE, m:'nose'},
            {t:'SOST√âN', b:4, y:'holdlow', c:C_HOLD, m:'nose'}
        ],
        '5-5': [
            {t:'INHALA', b:5, y:'rise', c:C_INHALE, m:'nose'},
            {t:'EXHALA', b:5, y:'fall', c:C_EXHALE, m:'nose'}
        ]
    };

    // --- FRASES ZEN ---
    const pSubjects = ['El r√≠o antiguo', 'La brisa suave', 'El bamb√∫ flexible', 'La monta√±a quieta', 'Tu mente clara', 'El momento presente', 'La hoja seca', 'El agua profunda', 'Este aliento', 'La nube blanca', 'El vac√≠o f√©rtil', 'La ra√≠z fuerte', 'El amor inmenso', 'La belleza oculta', 'Tu coraz√≥n sabio', 'La flor del alma', 'La luz interior'];
    const pActions = ['fluye sin esfuerzo', 'no opone resistencia', 'se dobla sin romperse', 'observa en silencio', 'refleja el cielo', 'encuentra su camino', 'suelta el control', 'descansa en paz', 'existe sin m√°s', 'acepta el cambio', 'danza con el viento', 'crece despacio', 'abraza lo que es', 'florece sin prisa', 'sana las heridas', 'irradia calidez', 'ama sin apego', 've la verdad'];
    const pConclusions = ['S√© como el agua.', 'Todo es perfecto.', 'Paz infinita.', 'Vuelve al centro.', 'Nada que hacer.', 'Mente serena.', 'Simple y puro.', 'Aqu√≠ y ahora.', 'Conecta contigo.', 'Fluye con todo.', 'Amor es todo.', 'Belleza pura.', 'Eres el amor.', 'Suelta y conf√≠a.', 'Eres suficiente.', 'Luz radiante.'];
    const masterQuotes = ['El vac√≠o es forma, la forma es vac√≠o.', 'Si te doblas como el junco, el viento no te romper√°.', 'El viaje de mil millas comienza con un aliento.', 'Conoce lo blanco, pero conserva lo negro.', 'S√© el valle del universo, rec√≠belo todo.', 'Poco a poco, el barro se asienta y el agua se aclara.', 'Haz nada, y nada quedar√° sin hacer.', 'El amor no reclama posesi√≥n, sino que da libertad.', 'La belleza no est√° en el rostro, sino en la luz del coraz√≥n.', 'Aceptar es el verdadero acto de transformaci√≥n.'];

    function getWuWeiQuote() {
        if(Math.random() < 0.3) {
            return masterQuotes[Math.floor(Math.random() * masterQuotes.length)];
        } else {
            const s = pSubjects[Math.floor(Math.random() * pSubjects.length)];
            const a = pActions[Math.floor(Math.random() * pActions.length)];
            const c = pConclusions[Math.floor(Math.random() * pConclusions.length)];
            return `${s} ${a}. ${c}`;
        }
    }

    // STATE V1.3.0 Quotes ENABLED by default
    let state = {pk:null, data:[], dur:0, tempo:1.0, run:false, paused:false, startAudioTime:0, cyc:0, snd:false, met:false, quotesEnabled: true, music: true};

    let audioCtx = null;
    let nextNoteTime = 0.0;
    let currentBeatIndex = 0;
    let scheduleTimerID = null;
    const lookahead = 25.0;
    const scheduleAheadTime = 0.1;

    // --- DOM REFERENCES ---
    const els = {
        menu: document.getElementById('selectionMenu'),
        sph: document.getElementById('sphere'),
        ph: document.getElementById('phaseText'),
        cnt: document.getElementById('counterText'),
        qt: document.getElementById('phraseContent'),
        cvs: document.getElementById('breathGraph'),
        ctx: document.getElementById('breathGraph').getContext('2d'),
        cyc: document.getElementById('cycleBadge'),
        pat: document.getElementById('patternDisplay'),
        load: document.getElementById('loadingOverlay'),
        shareModal: document.getElementById('shareModal'),
        shareText: document.getElementById('shareText'),
        customOverlay: document.getElementById('customOverlay'),
        customInput: document.getElementById('customPatternInput'),
        shareConfigOverlay: document.getElementById('shareConfigOverlay'),
        pillPatternInput: document.getElementById('pillPatternInput'),
        pillNameInput: document.getElementById('pillNameInput'),
        pillMessageInput: document.getElementById('pillMessageInput'),
        modeIcon: document.getElementById('modeIcon')
    };

    function formatPatternInput(input) {
        let raw = input.value.replace(/[^0-9bBg]/g, '').toLowerCase();
        let formatted = '';
        for(let i=0; i < raw.length; i++) {
            const char = raw[i];
            const isDigit = /[0-9]/.test(char);
            if(isDigit) {
                if(formatted.length > 0) formatted += '-';
                formatted += char;
            } else {
                if(formatted.length > 0 && formatted.slice(-1) !== 'b') formatted += char;
            }
        }
        input.value = formatted;
    }

    if(els.customInput) {
        els.customInput.addEventListener('input', e => formatPatternInput(e.target));
    }

    if(els.pillPatternInput) {
        els.pillPatternInput.addEventListener('input', e => formatPatternInput(e.target));
    }

    window.toggleTooltip = function(el) {
        const tip = el.querySelector('.info-tooltip');
        if(tip) tip.classList.toggle('visible');
    };

    let deferredPrompt;
    const installBtn = document.getElementById('installBtn');

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installBtn.style.display = 'flex';
    });

    async function installApp() {
        if(deferredPrompt) {
            deferredPrompt.prompt();
            await deferredPrompt.userChoice;
            deferredPrompt = null;
        } else {
            alert('Para instalar: Usa el men√∫ del navegador ‚Üí A√±adir a inicio.');
        }
    }

    function openCustomModal() {
        els.customOverlay.style.display = 'flex';
        els.customInput.value = '';
        els.customInput.focus();
    }

    function parsePatternString(str) {
        const chunks = str.split('-');
        const defs = [
            {t:'INHALA', y:'rise', c:C_INHALE},
            {t:'MANT√âN', y:'holdhigh', c:C_HOLD},
            {t:'EXHALA', y:'fall', c:C_EXHALE},
            {t:'SOST√âN', y:'holdlow', c:C_HOLD},
            {t:'PAUSA', y:'holdlow', c:C_HOLD}
        ];
        let newPattern = [];
        chunks.forEach((chunk, i) => {
            let beats = parseInt(chunk.replace(/[^0-9]/g, ''));
            if(!isNaN(beats) && beats > 0) {
                let mode = 'nose';
                if(chunk.toLowerCase().includes('b')) mode = 'mouth';
                let defIdx = i % defs.length;
                newPattern.push({t: defs[defIdx].t, b: beats, y: defs[defIdx].y, c: defs[defIdx].c, m: mode});
            }
        });
        return newPattern;
    }

    function startCustom() {
        const val = els.customInput.value.trim();
        const newPattern = parsePatternString(val);
        if(newPattern.length < 2) {
            alert('Introduce al menos 2 fases v√°lidas.');
            return;
        }
        patterns['custom'] = newPattern;
        els.customOverlay.style.display = 'none';
        start('custom');
    }

    function initAudio() {
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if(audioCtx.state === 'suspended') audioCtx.resume().catch(() => {});
    }

    function playTone(freq, type, dur, time) {
        if(!state.snd && !state.met) return;
        try {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, time);
            let vol = 0.0;
            if(state.snd) vol = 0.05;
            if(state.met && type === 'square') vol = 0.05;
            if(state.met && state.snd && type === 'square') vol = 0.08;
            gain.gain.setValueAtTime(vol, time);
            gain.gain.exponentialRampToValueAtTime(0.001, time + dur);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(time);
            osc.stop(time + dur);
        } catch(e) {}
    }

    function scheduleNote(beatNumber, time) {
        if(state.paused) return;
        let accumulatedBeats = 0;
        let phase = null;
        let beatInPhase = 0;
        for(let p of state.data) {
            if(beatNumber >= accumulatedBeats && beatNumber < accumulatedBeats + p.b) {
                phase = p;
                beatInPhase = beatNumber - accumulatedBeats + 1;
                break;
            }
            accumulatedBeats += p.b;
        }
        if(phase) {
            if(beatInPhase === 1) {
                let freq = 440;
                if(phase.y === 'rise') freq = 300;
                else if(phase.y === 'holdhigh') freq = 450;
                else if(phase.y === 'fall') freq = 400;
                else freq = 250;
                playTone(freq, 'sine', 0.2, time);
            }
            if(state.met) {
                playTone(beatInPhase === 1 ? 1200 : 800, 'square', 0.05, time);
            }
        }
    }

    function nextBeat() {
        if(state.paused) return;
        const secondsPerBeat = state.tempo;
        nextNoteTime += secondsPerBeat;
        currentBeatIndex++;
        const totalBeats = state.data.reduce((acc, p) => acc + p.b, 0);
        if(currentBeatIndex >= totalBeats) {
            currentBeatIndex = 0;
            state.cyc++;
            if(state.quotesEnabled) updateQuote();
        }
    }

    function updateQuote() {
        const rawQuote = getWuWeiQuote();
        els.qt.innerHTML = rawQuote.replace('. ', '.<br>');
    }

    function scheduler() {
        if(state.run) {
            if(!state.paused) {
                while(nextNoteTime < audioCtx.currentTime + scheduleAheadTime) {
                    scheduleNote(currentBeatIndex, nextNoteTime);
                    nextBeat();
                }
            } else {
                nextNoteTime = audioCtx.currentTime;
            }
            scheduleTimerID = setTimeout(scheduler, lookahead);
        }
    }

    function togglePause() {
        if(!state.run) return;
        state.paused = !state.paused;
        if(state.paused) {
            els.ph.textContent = 'PAUSA';
            els.ph.style.color = '#78909c';
            els.modeIcon.style.opacity = 0.5;
        } else {
            nextNoteTime = audioCtx.currentTime;
        }
    }

    // --- V1.3.0 LOGICA TOGGLE FRASES ---
    function toggleQuotes() {
        state.quotesEnabled = !state.quotesEnabled;
        const btn = document.getElementById('quoteToggleBtn');
        if(state.quotesEnabled) {
            // ENCENDIDO: Bot√≥n brilla, frase aparece y se actualiza
            btn.classList.add('active');
            updateQuote(); // Cargar nueva frase al encender
            els.qt.style.opacity = '1';
        } else {
            // APAGADO: Bot√≥n normal, frase se desvanece pero el hueco queda
            btn.classList.remove('active');
            els.qt.style.opacity = '0';
        }
    }

    function draw() {
        if(!state.run) return;
        if(state.paused) {
            requestAnimationFrame(draw);
            return;
        }
        const currentTime = audioCtx.currentTime;
        const elapsed = currentTime - state.startAudioTime;
        const totalCycleDur = state.dur;
        const cycleCountVisual = Math.floor(elapsed / totalCycleDur);
        els.cyc.textContent = cycleCountVisual;
        const timeInCycle = (elapsed % totalCycleDur);
        const p = state.data.find(x => timeInCycle >= x.start && timeInCycle < x.end);
        
        if(p) {
            // Actualizar textos y colores si cambian
            if(els.ph.textContent !== p.t) {
                els.ph.textContent = p.t;
                els.ph.style.color = p.c;
            }
            
            // Iconos
            const isHold = (p.y === 'holdhigh' || p.y === 'holdlow');
            if(isHold) {
                els.modeIcon.textContent = '‚è∏';
                els.modeIcon.classList.add('visible');
            } else if(p.m === 'mouth') {
                els.modeIcon.textContent = 'üí®';
                els.modeIcon.classList.add('visible');
            } else {
                els.modeIcon.textContent = 'üëÉ';
                els.modeIcon.classList.add('visible');
            }
            els.sph.style.setProperty('--c-phase', p.c);
            
            // Indicador de pasos (puntos abajo)
            const currentPhaseIdx = state.data.indexOf(p);
            state.data.forEach((_, idx) => {
                const el = document.getElementById(`p-step-${idx}`);
                if(el) {
                    if(idx === currentPhaseIdx) el.classList.add('active');
                    else el.classList.remove('active');
                }
            });
            
            // Contador num√©rico
            const timeInPhase = timeInCycle - p.start;
            let currentBeat = Math.floor(timeInPhase / state.tempo) + 1;
            currentBeat = Math.min(currentBeat, p.b);
            els.cnt.textContent = currentBeat;
            
            // --- CORRECCI√ìN MATEM√ÅTICA ---
            const progress = timeInPhase / p.dur;
            // Esta f√≥rmula va suavemente de 0 a 1 (sin negativos)
            const ease = (1 - Math.cos(Math.PI * progress)) / 2;
            
            let maxScale = 1.45;
            if(window.innerWidth < 400) maxScale = 1.35;
            let rawScale = 1;
            
            if(p.y === 'rise') rawScale = 0.8 + (maxScale - 0.8) * ease;
            else if(p.y === 'fall') rawScale = maxScale - (maxScale - 0.8) * ease;
            else if(p.y === 'holdhigh') rawScale = maxScale;
            else rawScale = 0.8;
            
            els.sph.style.transform = `scale(${rawScale})`;
        }
        
        // --- DIBUJADO DE CANVAS (L√≠nea de tiempo) ---
        const w = els.cvs.width / (window.devicePixelRatio||1);
        const h = els.cvs.height / (window.devicePixelRatio||1);
        els.ctx.clearRect(0, 0, w, h);
        const centerX = w / 2;
        const trackY = h / 2;
        const trackH = 14;
        const pxPerSec = (w / 7) / state.tempo;
        for(let c = cycleCountVisual - 1; c <= cycleCountVisual + 1; c++) {
            const cycleStartTime = c * totalCycleDur;
            state.data.forEach(phase => {
                const pStartAbs = cycleStartTime + phase.start;
                const pEndAbs = cycleStartTime + phase.end;
                const xStart = centerX + (pStartAbs - elapsed) * pxPerSec;
                const xEnd = centerX + (pEndAbs - elapsed) * pxPerSec;
                if(xEnd < 0 || xStart > w) return;
                els.ctx.fillStyle = phase.c;
                els.ctx.fillRect(xStart, trackY - trackH/2, xEnd - xStart, trackH);
                els.ctx.strokeStyle = 'rgba(255,255,255,0.9)';
                els.ctx.lineWidth = 2;
                for(let b = 0; b <= phase.b; b++) {
                    const beatTimeAbs = pStartAbs + b * state.tempo;
                    const markX = centerX + (beatTimeAbs - elapsed) * pxPerSec;
                    els.ctx.beginPath();
                    els.ctx.moveTo(markX, trackY - trackH - 2);
                    els.ctx.lineTo(markX, trackY + trackH + 2);
                    els.ctx.stroke();
                }
            });
        }
        els.ctx.beginPath();
        els.ctx.fillStyle = '#FFFFFF';
        els.ctx.arc(centerX, trackY, 9, 0, Math.PI * 2);
        els.ctx.fill();
        els.ctx.strokeStyle = 'rgba(0,0,0,0.1)';
        els.ctx.lineWidth = 1;
        els.ctx.stroke();
        els.ctx.beginPath();
        els.ctx.fillStyle = '#37474f';
        els.ctx.moveTo(centerX - 6, trackY - 25);
        els.ctx.lineTo(centerX + 6, trackY - 25);
        els.ctx.lineTo(centerX, trackY - 15);
        els.ctx.fill();
        requestAnimationFrame(draw);
    }

    function prepareData(k) {
        if(!patterns[k]) return false;
        state.pk = k;
        state.data = [];
        let acc = 0;
        patterns[k].forEach(x => {
            const d = x.b * state.tempo;
            state.data.push({...x, start:acc, end:acc+d, dur:d});
            acc += d;
        });
        state.dur = acc;
        return true;
    }

    function initCanvas() {
        if(!els.cvs) return;
        const dpr = window.devicePixelRatio || 1;
        const rect = els.cvs.getBoundingClientRect();
        els.cvs.width = rect.width * dpr;
        els.cvs.height = rect.height * dpr;
        els.ctx.scale(dpr, dpr);
    }

    function renderPattern(k) {
        if(!patterns[k]) return;
        els.pat.innerHTML = '';
        patterns[k].forEach((step, idx) => {
            const numSpan = document.createElement('span');
            numSpan.textContent = step.b;
            if(step.m === 'mouth') {
                const sub = document.createElement('span');
                sub.textContent = 'b';
                sub.className = 'p-mode-sub';
                numSpan.appendChild(sub);
            }
            numSpan.className = 'p-num';
            numSpan.id = `p-step-${idx}`;
            els.pat.appendChild(numSpan);
            if(idx < patterns[k].length - 1) {
                const sep = document.createElement('span');
                sep.textContent = '‚Äî';
                sep.className = 'p-sep';
                els.pat.appendChild(sep);
            }
        });
    }

    function start(k) {
        if(!prepareData(k)) {
            alert('Error: Patr√≥n no encontrado');
            return;
        }
        // M√öSICA: Play si el bot√≥n est√° activo
        if(state.music) {
            ambientAudio.currentTime = 0;
            ambientAudio.play().catch(e => console.log('Audio error', e));
        }
        initAudio();
        renderPattern(k);
        els.menu.style.opacity = '0';
        setTimeout(() => els.menu.style.display='none', 400);

        // V1.3.0 Reset states: Queremos que empiece ENCENDIDO por defecto
        state.quotesEnabled = true;
        const btn = document.getElementById('quoteToggleBtn');
        btn.classList.add('active'); // Bot√≥n iluminado
        els.qt.style.opacity = '1'; // Frase visible
        els.qt.textContent = 'Sigue el ritmo, respira, nada m√°s.'; // Frase inicial

        setTimeout(() => {
            initCanvas();
            state.run = true;
            state.paused = false;
            state.startAudioTime = audioCtx ? audioCtx.currentTime : 0;
            nextNoteTime = state.startAudioTime;
            currentBeatIndex = 0;
            state.cyc = 0;
            if(audioCtx) scheduler();
            requestAnimationFrame(draw);
        }, 100);
    }

    function stop() {
        // --- LIMPIEZA MODO INVIERNO (NUEVO) ---
        // Quitamos la clase para que vuelvan los colores
        document.querySelector('.app-layout').classList.remove('winter-mode');
        
        // Apagamos v√≠deo y audio de invierno
        const vid = document.getElementById('bgVideo');
        const aud = document.getElementById('winterAudio');
        if(vid) vid.pause();
        if(aud) { aud.pause(); aud.currentTime = 0; }
        // --------------------------------------
        ambientAudio.pause();
        state.run = false;
        clearTimeout(scheduleTimerID);
        els.sph.style.transform = 'scale(0.8)';
        els.ph.textContent = 'LISTO';
        els.ph.style.color = 'var(--accent)';
        els.modeIcon.classList.remove('visible');
        els.cnt.textContent = '';
        els.cyc.textContent = '0';
        els.sph.style.setProperty('--c-phase', '#4CAF50');
        els.menu.style.display = 'flex';
        setTimeout(() => els.menu.style.opacity = '1', 10);
        els.pat.innerHTML = '';
        els.ctx.clearRect(0, 0, els.cvs.width, els.cvs.height);
    }

    function toggleTempo() {
        const t = [1.0, 1.5, 2.0];
        const idx = t.indexOf(state.tempo);
        const next = t[(idx+1)%t.length];
        state.tempo = next;
        document.getElementById('tempoBtn').innerText = next===1.0?'1x':next===1.5?'Lento':'Zen';
        if(state.run) start(state.pk);
    }

    function toggleSound() {
        state.snd=!state.snd;
        document.getElementById('soundBtn').textContent=state.snd?'üîî':'üîï';
        if(state.run) initAudio();
    }

    function toggleMetronome() {
        state.met=!state.met;
        document.getElementById('metronomeBtn').classList.toggle('active');
    }

    function toggleMusic() {
    state.music = !state.music;
    const audPaisaje = document.getElementById('winterAudio');

    if (state.music) {
        els.musicIcon.textContent = 'volume_up';
        if (typeof ambientAudio !== 'undefined' && ambientAudio) ambientAudio.play();
        
        // Si el paisaje est√° activo, reanudamos su audio
        if (document.querySelector('.app-layout').classList.contains('winter-mode') && audPaisaje) {
            audPaisaje.play();
        }
    } else {
        els.musicIcon.textContent = 'volume_off';
        if (typeof ambientAudio !== 'undefined' && ambientAudio) ambientAudio.pause();
        
        // Si el usuario silencia, pausamos el piano del paisaje
        if (audPaisaje) audPaisaje.pause();
    }
}

    function openShareConfig() {
        let lastP = state.pk;
        if(lastP && lastP !== 'custom') {
            els.pillPatternInput.value = lastP;
        }
        els.shareConfigOverlay.style.display = 'flex';
        els.pillPatternInput.focus();
    }

    async function generateShareLink() {
        let pString = els.pillPatternInput.value.trim();
        if(!pString) {
            alert('Falta el patr√≥n.');
            return;
        }
        const testP = parsePatternString(pString);
        if(testP.length < 2) {
            alert('Patr√≥n inv√°lido. Ej: 4-7-8b');
            return;
        }
        const n = els.pillNameInput.value.trim() || 'Amigo';
        const m = els.pillMessageInput.value.trim() || 'Respira conmigo...';
        els.shareConfigOverlay.style.display = 'none';
        els.load.style.display = 'flex';
        const baseUrl = location.href.split('?')[0];
        const longUrl = `${baseUrl}?p=${encodeURIComponent(pString)}&to=${encodeURIComponent(n)}&msg=${encodeURIComponent(m)}`;
        let finalUrl = longUrl;
        try {
            const response = await fetch(`https://tinyurl.com/api-create.php?url=${encodeURIComponent(longUrl)}`);
            if(response.ok) finalUrl = await response.text();
        } catch(e) {}
        els.load.style.display = 'none';
        els.shareText.value = `P√≠ldora de Respiraci√≥n:\n${m}\n‚Üí ${pString}\n${finalUrl}`;
        els.shareModal.style.display = 'flex';
    }

    function sendWhatsapp() {
        window.open(`https://wa.me/?text=${encodeURIComponent(els.shareText.value)}`, '_blank');
    }

    function copyToClipboard() {
        els.shareText.select();
        els.shareText.setSelectionRange(0, 99999);
        try {
            navigator.clipboard.writeText(els.shareText.value).then(() => alert('¬°Copiado!'));
        } catch(e) {
            document.execCommand('copy');
            alert('¬°Copiado!');
        }
    }

    function closePill() {
        document.getElementById('pillOverlay').style.display = 'none';
    }

    // CHECK SHARE
    window.addEventListener('load', () => {
        const params = new URLSearchParams(window.location.search);
        if(params.has('p')) {
            const pString = params.get('p');
            const to = params.get('to') || 'Amigo';
            const msg = params.get('msg') || 'Respira conmigo...';
            document.getElementById('pillRecipient').textContent = `Para ${to}`;
            document.getElementById('pillMessage').textContent = msg;
            const newPattern = parsePatternString(pString);
            if(newPattern.length >= 2) {
                patterns['pill'] = newPattern;
                document.getElementById('pillOverlay').style.display = 'flex';
                setTimeout(() => {
                    closePill();
                    start('pill');
                }, 3000);
            }
        }
    });
    // --- FUNCI√ìN MODO INVIERNO (VERSI√ìN LIMPIA) ---
    function startWinterMode() {
    // 1. Recogemos el ritmo que el usuario ha escrito en la pantalla intermedia
    const ritmo = document.getElementById('psPatternInput').value.trim() || "4-4-4-4";
    
    // 2. Sincronizamos con el motor oficial (usando el modo 'custom')
    els.customInput.value = ritmo;

    // 3. Cerramos el panel de selecci√≥n
    closeSoundscapeSettings();

    // 4. Lanzamos el motor (Esto har√° que la esfera y la l√≠nea funcionen solas)
    start('custom');

    // 5. Activamos Multimedia
    document.querySelector('.app-layout').classList.add('winter-mode');
    const vid = document.getElementById('bgVideo');
    const aud = document.getElementById('winterAudio');
    
    if(vid) { 
        vid.src = "cielo.mp4"; 
        vid.play().catch(e => console.log("Video listo")); 
    }
    
    if(aud) { 
        aud.src = "clavier_1.mp3"; 
        aud.volume = 0.5; 
        // Solo suena si el bot√≥n global de m√∫sica NO est√° tachado
        if (state.music) {
            aud.play().catch(e => console.log("Piano iniciado"));
        }
    }

    // 6. Ajuste visual (MANTENEMOS los n√∫meros visibles en la esfera)
    setTimeout(() => {
        // He eliminado la l√≠nea que pon√≠a el innerHTML a ''
        document.documentElement.style.setProperty('--c-phase', '#ffffff');
    }, 150);
}
// --- FUNCIONES DE CONTROL PAISAJE SONORO ---
function openSoundscapeSettings() {
    const overlay = document.getElementById('psOverlay');
    if(overlay) {
        overlay.style.display = 'flex';
        const input = document.getElementById('psPatternInput');
        if(input) input.focus();
    }
}

function closeSoundscapeSettings() {
    const overlay = document.getElementById('psOverlay');
    if(overlay) overlay.style.display = 'none';
}

// Listener para los guiones autom√°ticos
const psInp = document.getElementById('psPatternInput');
if(psInp) {
    psInp.addEventListener('input', (e) => {
        formatPattern(e.target);
    });
}    
</script>
    
</body>
</html>
