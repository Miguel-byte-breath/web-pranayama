<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Respira | Tu Espacio de Calma</title>
  
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="theme-color" content="#eefcfd">
  <meta name="description" content="Una aplicaci√≥n minimalista para respirar, relajarse y leer.">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;700&family=Manrope:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    /* --- 1. BASE & VARIABLES --- */
    :root {
      --dune-light: #eefcfd;
      --dune-mid: #e0f7fa;
      --text-main: #37474f;
      --text-muted: #78909c;
      --primary: #4CAF50; 
      --accent: #00838f;
      --substack-orange: #FF6719;
      
      --c-inhale: #4CAF50; 
      --c-hold: #FF9800;   
      --c-exhale: #2196F3; 
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      background-color: var(--dune-light);
      background-image: 
        radial-gradient(at 0% 0%, hsla(190,40%,96%,1) 0px, transparent 50%),
        radial-gradient(at 100% 0%, hsla(195,50%,90%,1) 0px, transparent 50%),
        radial-gradient(at 50% 100%, hsla(185,60%,88%,1) 0px, transparent 50%);
      background-attachment: fixed;
      color: var(--text-main); 
      font-family: 'Manrope', sans-serif;
      height: 100dvh; width: 100vw; overflow: hidden; 
      display: flex; flex-direction: column;
    }

    /* --- 2. LAYOUT GENERAL --- */
    .app-layout {
      flex: 1; display: flex; flex-direction: column; 
      width: 100%; height: 100%;
    }

    .top-bar {
      flex-shrink: 0; display: flex; justify-content: space-between; align-items: center;
      padding: 15px 25px; z-index: 50; height: 70px;
    }
    .top-left, .top-right { pointer-events: auto; display: flex; gap: 12px; align-items: center; }

    .badge {
      background: rgba(255,255,255,0.6); 
      backdrop-filter: blur(10px);
      color: var(--accent); 
      border: 1px solid rgba(255,255,255,0.4);
      padding: 6px 14px; border-radius: 20px;
      font-weight: 700; font-size: 0.85rem; 
    }
    
    .btn-icon {
      background: rgba(255,255,255,0.5); 
      backdrop-filter: blur(4px);
      border: 1px solid rgba(255,255,255,0.3);
      width: 44px; height: 44px; border-radius: 50%;
      color: var(--text-main); font-size: 1.1rem;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all 0.3s ease;
    }
    .btn-icon:hover { background: rgba(255,255,255,0.9); transform: translateY(-2px); }
    .btn-icon:active { transform: scale(0.95); }
    
    /* V1.2.0: Estado ACTIVO para botones toggle (Metr√≥nomo y Frases) */
    .btn-icon.active { 
        background: var(--accent); 
        color: white; 
        border-color: var(--accent); 
        box-shadow: 0 0 15px rgba(0, 131, 143, 0.4);
    }

    .btn-text {
      background: rgba(255,255,255,0.5); 
      backdrop-filter: blur(4px);
      border: 1px solid rgba(255,255,255,0.3);
      padding: 8px 20px; border-radius: 30px;
      color: var(--text-main); font-weight: 600; cursor: pointer; 
      transition: all 0.3s ease;
      font-family: 'Manrope', sans-serif;
    }

    /* --- 3. ESCENARIO CENTRAL --- */
    .stage-container {
      flex: 1; display: flex; width: 100%; position: relative;
      align-items: center; justify-content: center;
      flex-direction: column; 
      padding: 10px 0;
    }

    .panel-side { 
        flex: 1; display: flex; flex-direction: column; 
        align-items: center; justify-content: center; 
        z-index: 20; width: 100%; 
        min-height: 90px;
    }
    
    .panel-center { 
        position: relative; z-index: 10; 
        display: flex; align-items: center; justify-content: center; 
        margin: 60px 0; 
        flex-shrink: 0; 
    }

    .phase-text {
      font-family: 'Cinzel', serif;
      font-size: clamp(2.5rem, 6vw, 4rem); 
      font-weight: 400; letter-spacing: 2px; color: var(--accent);
      text-transform: uppercase; text-align: center; white-space: nowrap;
      transition: color 0.5s ease;
      text-shadow: 0 10px 30px rgba(168, 206, 212, 0.4);
      z-index: 30;
      margin-bottom: 5px;
    }

    .mode-indicator {
      margin-top: 10px;
      font-size: 2.5rem; 
      opacity: 0; transform: translateY(-10px);
      transition: all 0.5s ease;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
      z-index: 50; 
    }
    .mode-indicator.visible { opacity: 1; transform: translateY(0); }

    .quote {
      padding: 0 25px; color: var(--text-muted);
      font-family: 'Cinzel', serif; 
      font-size: 1.15rem; text-align: center;
      max-width: 500px; 
      line-height: 1.6;
      z-index: 30;
      margin-top: 10px; 
      /* V1.2.0: Altura m√≠nima para evitar saltos y transici√≥n suave */
      min-height: 2em; 
      transition: opacity 0.6s ease;
    }

    .sphere-wrapper {
      position: relative; 
      width: min(50vw, 260px); height: min(50vw, 260px);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; 
    }

    .sphere {
      width: 100%; height: 100%; border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.95), var(--c-phase));
      box-shadow: 0 20px 70px var(--c-phase), inset 0 0 20px rgba(255,255,255,0.5);
      display: flex; align-items: center; justify-content: center; flex-direction: column;
      will-change: transform, background; 
      transform: scale(0.8);
      transition: background 0.5s ease, box-shadow 0.5s ease;
    }

    .counter-big { 
      font-family: 'Manrope', sans-serif;
      font-size: 4rem; font-weight: 800; color: white; 
      text-shadow: 0 2px 15px rgba(0,0,0,0.15); line-height: 1;
    }
    
    .sphere-label {
        margin-top: 10px; 
        display: flex; align-items: center; justify-content: center; gap: 6px;
        z-index: 25;
    }
    .p-num {
      font-size: 0.9rem; color: rgba(255,255,255,0.6); font-weight: 500;
      transition: all 0.2s ease; display: inline-block;
    }
    .p-mode-sub { font-size: 0.6em; vertical-align: super; opacity: 0.8; margin-left:1px; }

    .p-sep { font-size: 0.8rem; color: rgba(255,255,255,0.4); }
    .p-num.active {
      color: #fff; font-weight: 800; transform: scale(1.4);
      text-shadow: 0 0 12px rgba(255,255,255,1);
    }

    /* --- 4. VISUALIZADOR --- */
    .bottom-viz {
      flex-shrink: 0; width: 100%; height: 90px; 
      margin: 0 auto 4vh auto; 
      position: relative; z-index: 15;
      -webkit-mask-image: linear-gradient(to right, transparent 0%, black 20%, black 80%, transparent 100%);
      mask-image: linear-gradient(to right, transparent 0%, black 20%, black 80%, transparent 100%);
    }
    #breathGraph { width: 100%; height: 100%; display: block; }

    /* --- 5. MEN√ö SELECCI√ìN --- */
    #selectionMenu {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(238, 252, 253, 0.95);
      z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 30px; transition: opacity 0.4s ease;
    }

    /* --- LUCES (Estacional) --- */
    .navidad-lights {
        position: absolute; top: 0; left: 0; width: 100%;
        display: flex; justify-content: space-around; padding: 8px 0;
        pointer-events: none; z-index: 120;
    }
    .light {
        width: 10px; height: 10px; border-radius: 50%;
        animation: breath-light 4s infinite ease-in-out;
    }
    .light.red   { background: #ff4d4d; box-shadow: 0 0 12px #ff4d4d; animation-delay: 0s; }
    .light.green { background: #2ecc71; box-shadow: 0 0 12px #2ecc71; animation-delay: 1.3s; }
    .light.blue  { background: #4facfe; box-shadow: 0 0 12px #4facfe; animation-delay: 2.6s; }
    @keyframes breath-light {
        0%, 100% { opacity: 0.2; transform: scale(0.8); }
        50% { opacity: 1; transform: scale(1.15); box-shadow: 0 0 20px currentColor; }
    }

    /* --- BOTONES Y TEXTOS --- */
    .global-info-btn {
        position: absolute; top: 30px; right: 30px;
        width: 42px; height: 42px; border-radius: 50%;
        background: rgba(255,255,255,0.9);
        border: 1px solid rgba(76, 175, 80, 0.3);
        color: var(--primary);
        font-family: 'Manrope', sans-serif; font-weight: 800; 
        display: flex; align-items: center; justify-content: center;
        font-size: 1.2rem; cursor: pointer;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.15); 
        transition: all 0.3s ease;
        z-index: 110;
    }
    .global-info-btn:hover { 
        background: var(--primary); color: white; transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
    }

    .menu-title { 
      font-family: 'Cinzel', serif; font-size: 2.2rem; 
      color: #263238; margin-bottom: 30px; 
      letter-spacing: 0.1em; font-weight: 500; text-align: center;
      background: -webkit-linear-gradient(45deg, #263238, #546e7a);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }

    .menu-actions {
        display: flex; gap: 15px; margin-bottom: 30px; width: 100%; justify-content: center;
    }
    .action-btn {
        background: white; border: 1px solid rgba(0,0,0,0.05);
        padding: 12px 20px; border-radius: 30px;
        color: var(--accent); font-weight: 600; font-size: 0.9rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer;
        display: flex; align-items: center; gap: 8px;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .action-btn:active { transform: scale(0.95); }

    .menu-grid {
      display: grid; grid-template-columns: 1fr; gap: 15px;
      width: 100%; max-width: 450px; max-height: 55vh; overflow-y: auto; 
      padding: 5px;
    }

    /* --- TARJETAS --- */
    .menu-card {
      background: rgba(255, 255, 255, 0.6); 
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.8);
      padding: 20px; border-radius: 16px;
      cursor: pointer; text-align: left;
      transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      box-shadow: 0 4px 10px rgba(178, 235, 242, 0.1);
      position: relative;
    }
    .menu-card:hover { 
      transform: translateY(-3px) scale(1.01); 
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 10px 25px rgba(178, 235, 242, 0.3);
    }
    .menu-card h3 { 
        color: #37474f; font-size: 1.1rem; margin-bottom: 4px; 
        font-weight: 700; font-family: 'Manrope', sans-serif;
    }
    .menu-card p { color: #78909c; font-size: 0.9rem; font-weight: 400; }
    .menu-card.custom-card { border: 2px dashed rgba(0, 131, 143, 0.3); background: rgba(255, 255, 255, 0.4); }
    .menu-card.custom-card h3 { color: var(--accent); }

    /* --- SUBSTACK CARD (PRO) --- */
    .substack-card {
        background: linear-gradient(135deg, #FFFFFF 0%, #F0FFF4 50%, #E0F2F1 100%);
        border: 1px solid rgba(255, 103, 25, 0.15); 
        border-radius: 16px; 
        padding: 25px 22px; 
        min-height: 100px;
        cursor: pointer; position: relative; overflow: hidden;
        box-shadow: 0 8px 25px rgba(200, 230, 201, 0.4);
        transition: all 0.4s ease;
        display: flex; flex-direction: row; 
        align-items: center; justify-content: flex-start; 
        gap: 15px; 
        flex-wrap: nowrap; 
    }
    .substack-card::before {
        content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, transparent 70%);
        opacity: 0.6; pointer-events: none; transform: rotate(30deg);
    }
    .substack-card:hover {
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 12px 30px rgba(200, 230, 201, 0.6), 0 0 10px rgba(255, 103, 25, 0.1);
    }
    .substack-icon {
        width: 42px; height: 42px; flex-shrink: 0; 
        background: white; border-radius: 8px; 
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05); z-index: 2;
    }
    .substack-content { 
        z-index: 2; flex: 1; min-width: 0; 
        display: flex; flex-direction: column; justify-content: center;
    }
    .substack-label {
        font-family: 'Manrope', sans-serif; font-size: 0.65rem; 
        text-transform: uppercase; letter-spacing: 2px; 
        color: #78909c; font-weight: 700; margin-bottom: 4px;
    }
    .substack-title {
        font-family: 'Cinzel', serif; font-weight: 700; font-size: 1.2rem; color: #263238;
        margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        line-height: 1.2;
    }
    .substack-author {
        font-family: 'Manrope', sans-serif; font-size: 0.9rem; color: var(--substack-orange); 
        font-weight: 600; 
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    /* --- OVERLAYS --- */
    #customOverlay, #shareConfigOverlay, #guideOverlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255, 255, 255, 0.98); z-index: 150;
        display: none; 
        flex-direction: column; align-items: center; justify-content: flex-start; 
        padding-top: 15vh;
        overflow-y: auto; 
        backdrop-filter: blur(15px); text-align: center;
    }
    
    .overlay-title { font-family:'Cinzel'; color:var(--text-main); margin-bottom:10px; font-size: 1.5rem; }
    .overlay-subtitle { color:var(--text-muted); margin-bottom:30px; font-size: 0.95rem; }

    .custom-input-container {
        position: relative; margin: 15px 0;
        display: flex; align-items: center; justify-content: center;
    }
    
    .big-input {
        font-size: 2.8rem; font-family: 'Manrope', sans-serif; font-weight: 300;
        border: none; border-bottom: 2px solid var(--accent);
        background: transparent; color: var(--text-main);
        width: 320px; text-align: center; letter-spacing: 2px;
        outline: none; padding-bottom: 5px; border-radius: 0;
    }
    
    .normal-input {
        width: 80%; max-width: 300px; padding: 12px; margin: 10px 0;
        border: 1px solid #cfd8dc; border-radius: 10px;
        font-family: 'Manrope', sans-serif; font-size: 1rem; color: var(--text-main);
        background: #fcfcfc; outline: none; text-align: center;
    }
    .normal-input:focus { border-color: var(--accent); background: white; }

    .info-bubble {
        width: 32px; height: 32px; 
        background: var(--text-muted); color: white; border-radius: 50%;
        display: flex; align-items: center; justify-content: center; 
        font-size: 1.1rem; font-weight: bold; cursor: pointer; 
        margin-left: 15px; position: relative;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    /* TOOLTIP DE AYUDA (Estilo Burbuja) */
    .info-tooltip {
        position: absolute; top: 50px; left: 50%; transform: translateX(-85%);
        width: 290px; background: #37474f; color: white; padding: 20px;
        border-radius: 12px; font-size: 0.9rem; line-height: 1.6;
        opacity: 0; visibility: hidden; transition: all 0.3s ease; 
        box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 200; text-align: left;
    }
    .info-tooltip.visible { opacity: 1; visibility: visible; }
    .info-tooltip::before {
        content:''; position: absolute; top: -6px; right: 20px;
        border-width: 6px; border-style: solid; 
        border-color: transparent transparent #37474f transparent;
    }

    .guide-row { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; text-align: left; }
    .guide-icon { font-size: 1.5rem; width: 40px; text-align: center; }
    
    .overlay-btn-group { display: flex; gap: 15px; margin-top: 30px; }
    
    .refugio-btn {
        background: linear-gradient(135deg, #FF6719 0%, #FF8A50 100%);
        color: white; border: none; padding: 15px 40px; font-size: 1.1rem;
        border-radius: 50px; font-weight: 700; font-family: 'Manrope', sans-serif;
        box-shadow: 0 5px 15px rgba(255, 103, 25, 0.3);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .refugio-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(255, 103, 25, 0.4); }

    /* --- PILL SHARE --- */
    #pillOverlay, #shareModal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255,255,255,0.95); z-index: 250;
        display: none; flex-direction: column; align-items: center; justify-content: center;
        padding: 30px; text-align: center;
    }
    #shareText {
        width: 100%; max-width: 350px; height: 100px;
        margin: 20px 0; padding: 15px; border-radius: 12px;
        border: 1px solid #ddd; font-family: 'Manrope', sans-serif;
        background: #f9f9f9; font-size: 0.9rem;
    }
    .share-actions { display: flex; gap: 10px; width: 100%; max-width: 350px; }
    .btn-wa { flex: 1; background: #25D366; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 700; cursor: pointer; }
    .btn-copy { flex: 1; background: #607d8b; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 700; cursor: pointer; }

    /* --- LOADING --- */
    .loading-overlay {
        position: absolute; top:0; left:0; width:100%; height:100%;
        background: rgba(255,255,255,0.9); z-index: 300;
        display: none; align-items: center; justify-content: center;
        flex-direction: column; gap: 15px; color: var(--accent); font-weight: 600;
    }
    .spinner {
        width: 40px; height: 40px; border: 4px solid #e0f7fa; 
        border-top: 4px solid var(--accent); border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    @media (max-width: 768px) {
      .sphere-wrapper { width: 260px; height: 260px; }
      .phase-text { font-size: 2.5rem; }
      .counter-big { font-size: 3.5rem; }
      .top-bar { padding: 10px 15px; height: 60px; }
      .badge { font-size: 0.75rem; padding: 4px 10px; }
      .btn-icon { width: 40px; height: 40px; font-size: 1rem; }
      .substack-card { padding: 15px; gap: 12px; }
      .substack-icon { width: 36px; height: 36px; }
      .substack-title { font-size: 1rem; }
      .big-input { width: 260px; font-size: 2.2rem; }
      .global-info-btn { top: 15px; right: 15px; width: 36px; height: 36px; font-size: 1rem; }
      .info-tooltip { width: 260px; top: 45px; right: -10px; transform: translateX(0); left: auto; }
      .info-tooltip::before { right: 14px; left: auto; }
    }
  </style>
</head>
<body>

  <div id="loadingOverlay" class="loading-overlay">
      <div class="spinner"></div>
      <span>Preparando tu calma...</span>
  </div>

  <button class="global-info-btn" onclick="document.getElementById('guideOverlay').style.display='flex'">?</button>

  <div class="app-layout">
    <div class="top-bar">
      <div class="top-left">
        <div id="patternBadge" class="badge">4-7-8</div>
      </div>
      <div class="top-right">
        <div id="quoteToggleBtn" class="btn-icon active" onclick="toggleQuotes()">‚ùù</div>
        <div id="tempoBtn" class="btn-icon" onclick="toggleTempo()">‚ö°</div>
        <div id="metronomeBtn" class="btn-icon" onclick="toggleMetronome()">‚è±Ô∏è</div>
        <div id="soundBtn" class="btn-icon" onclick="toggleSound()">üîä</div>
        <div id="musicBtn" class="btn-icon active" onclick="toggleMusic()">üé∂</div>
      </div>
    </div>

    <div class="stage-container">
      
      <div class="panel-side" style="justify-content: flex-end;">
         <div id="phaseText" class="phase-text">LISTO</div>
         <div id="modeIcon" class="mode-indicator">üëÉ</div>
      </div>

      <div class="panel-center">
        <div class="sphere-wrapper" onclick="togglePause()">
          <div id="sphere" class="sphere">
             <div id="counterText" class="counter-big"></div>
          </div>
        </div>
      </div>

      <div class="panel-side" style="justify-content: flex-start;">
         <div id="patternSteps" class="sphere-label"></div>
         <div id="phraseContent" class="quote">
            "Sigue el ritmo, respira, nada m√°s."
         </div>
      </div>
      
    </div>

    <div class="bottom-viz">
      <canvas id="breathGraph" width="600" height="90"></canvas>
    </div>
  </div>

  <div id="selectionMenu">
    
    <div class="navidad-lights">
        <div class="light red"></div>
        <div class="light green"></div>
        <div class="light blue"></div>
        <div class="light red"></div>
        <div class="light green"></div>
    </div>

    <h2 class="menu-title">Elige tu Ritmo</h2>
    
    <div class="menu-actions">
        <div class="action-btn" onclick="openCustomModal()"><span>‚ú®</span> Crear</div>
        <div class="action-btn" onclick="openShareConfig()"><span>üéÅ</span> Compartir</div>
    </div>

    <div class="menu-grid">
      <div class="substack-card" onclick="window.open('https://elrefugiomental.substack.com', '_blank')">
          <div class="substack-icon">üß°</div>
          <div class="substack-content">
              <div class="substack-label">SUSCR√çBETE A</div>
              <div class="substack-title">El Refugio Mental</div>
              <div class="substack-author">de Jes√∫s Garc√≠a</div>
          </div>
      </div>

      <div class="menu-card" onclick="start('4-7-8b')">
        <h3>üåô Relajaci√≥n (4-7-8)</h3>
        <p>Inhala 4, Mant√©n 7, Exhala 8. Ideal para dormir.</p>
      </div>
      <div class="menu-card" onclick="start('4-4-6-2')">
        <h3>üßò‚Äç‚ôÇÔ∏è Calma Profunda</h3>
        <p>4-4-6-2. Equilibra el sistema nervioso.</p>
      </div>
      <div class="menu-card" onclick="start('box')">
        <h3>üì¶ Box Breathing</h3>
        <p>4-4-4-4. Enfoque mental y control.</p>
      </div>
      <div class="menu-card" onclick="start('5-5')">
        <h3>‚öñÔ∏è Coherencia</h3>
        <p>5-5. Sincroniza coraz√≥n y cerebro.</p>
      </div>
    </div>
  </div>

  <div id="customOverlay">
      <div class="overlay-title">Crea tu Ritmo</div>
      <div class="overlay-subtitle">Escribe los tiempos separados por guiones</div>
      
      <div class="custom-input-container">
          <input type="text" id="customPatternInput" class="big-input" placeholder="4-7-8b" autocomplete="off">
          <div class="info-bubble" onclick="toggleTooltip()">?
               <div id="inputTooltip" class="info-tooltip">
                   <strong>Formato:</strong> Inhala-Mant√©n-Exhala...<br><br>
                   ‚Ä¢ Usa n√∫meros para segundos.<br>
                   ‚Ä¢ A√±ade 'b' para exhalar por boca.<br>
                   ‚Ä¢ Ej: <strong>4-7-8b</strong> (4 in, 7 hold, 8 out boca).
               </div>
          </div>
      </div>

      <div class="overlay-btn-group">
          <button class="action-btn" onclick="startCustom()">Empezar</button>
          <button class="action-btn" style="background:transparent; border:1px solid #ccc; color:#666;" onclick="document.getElementById('customOverlay').style.display='none'">Cancelar</button>
      </div>
  </div>

  <div id="shareConfigOverlay">
      <div class="overlay-title">Regala Calma üíä</div>
      <div class="overlay-subtitle">Crea una p√≠ldora de respiraci√≥n para alguien</div>
      
      <input type="text" id="pillNameInput" class="normal-input" placeholder="¬øPara qui√©n es?" autocomplete="off">
      <input type="text" id="pillMessageInput" class="normal-input" placeholder="Mensaje (ej: T√≥mate 1 min)" autocomplete="off">
      
      <div class="overlay-btn-group">
          <button class="action-btn" onclick="generateShareLink()">Crear P√≠ldora</button>
          <button class="action-btn" style="background:transparent; border:1px solid #ccc; color:#666;" onclick="document.getElementById('shareConfigOverlay').style.display='none'">Cancelar</button>
      </div>
  </div>

  <div id="guideOverlay">
      <div class="overlay-title">Gu√≠a Visual</div>
      <div style="text-align:left; max-width:320px; background:white; padding:20px; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.05);">
          <div class="guide-row"><span class="guide-icon">üëÉ</span><span><strong>Nariz:</strong> Inhala suave y profundo por la nariz.</span></div>
          <div class="guide-row"><span class="guide-icon">‚è∏Ô∏è</span><span><strong>Pausa:</strong> Ret√©n el aire sin tensar el cuerpo.</span></div>
          <div class="guide-row"><span class="guide-icon">üå¨Ô∏è</span><span><strong>Boca:</strong> Exhala soltando todo el aire por la boca.</span></div>
          
          <div style="margin-top:20px; font-size:0.8rem; color:#888; border-top:1px solid #eee; padding-top:10px; margin-bottom:10px;">TIP AVANZADO</div>
          <div class="guide-row"><span class="guide-icon">üå¨Ô∏è</span><span><strong>Boca:</strong> Si ves este icono (o a√±ades 'b'), exhala soplando.</span></div>
      </div>
      
      <div style="margin-top:40px;">
          <button class="btn-text" style="background:transparent; color:var(--accent); border:1px solid var(--accent);" onclick="document.getElementById('guideOverlay').style.display='none'">Entendido</button>
      </div>
  </div>
  
  <div id="substackOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.98); z-index:300; display:flex; flex-direction:column; align-items:center; justify-content:center; display:none; text-align:center; padding:20px;">
      <h2 class="menu-title">üß° El Refugio Mental</h2>
      <p style="max-width:400px; color:#555; line-height:1.6; margin-bottom:30px;">
          √önete a m√°s de 200 personas que reciben mis reflexiones semanales sobre calma, productividad y vida consciente.
      </p>
      <button class="refugio-btn" onclick="window.open('https://elrefugiomental.substack.com', '_blank'); document.getElementById('substackOverlay').style.display='none';">Suscribirme Gratis</button>
      <button style="background:none; border:none; margin-top:20px; color:#999; text-decoration:underline; cursor:pointer;" onclick="document.getElementById('substackOverlay').style.display='none'">Quiz√°s luego</button>
  </div>

  <div id="shareModal">
      <h2 class="overlay-title">¬°P√≠ldora Lista!</h2>
      <textarea id="shareText" readonly></textarea>
      <div class="share-actions">
          <button class="btn-wa" onclick="sendWhatsapp()">WhatsApp</button>
          <button class="btn-copy" onclick="copyToClipboard()">Copiar</button>
      </div>
      <button class="btn-text" style="margin-top:30px; background:transparent; border:none;" onclick="document.getElementById('shareModal').style.display='none'">Cerrar</button>
  </div>
  
  <div id="pillOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:var(--dune-light); z-index:400; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:20px;">
      <div style="font-size:4rem; margin-bottom:20px;">üíä</div>
      <h3 id="pillRecipient" style="font-family:'Cinzel'; font-size:2rem; color:var(--text-main); margin-bottom:10px;">Hola...</h3>
      <p id="pillMessage" style="font-style:italic; color:#666; font-size:1.2rem; max-width:400px; line-height:1.5;">"..."</p>
      <button class="action-btn" style="margin-top:40px; transform:scale(1.2);" onclick="window.closePill()">Recibir P√≠ldora</button>
  </div>


  <script>
    // --- VARIABLES Y CONFIGURACI√ìN ---
    const C_INHALE = '#4CAF50'; 
    const C_HOLD   = '#FF9800'; 
    const C_EXHALE = '#2196F3'; 

    let patterns = {
      '4-4-6-2': [
          {t:"INHALA", b:4, y:'rise', c:C_INHALE, m:'nose'},
          {t:"MANT√âN", b:4, y:'hold_high', c:C_HOLD, m:'nose'},
          {t:"EXHALA", b:6, y:'fall', c:C_EXHALE, m:'nose'},
          {t:"SOST√âN", b:2, y:'hold_low', c:C_HOLD, m:'nose'}
      ],
      '4-7-8b': [
          {t:"INHALA", b:4, y:'rise', c:C_INHALE, m:'nose'},
          {t:"MANT√âN", b:7, y:'hold_high', c:C_HOLD, m:'nose'},
          {t:"EXHALA", b:8, y:'fall', c:C_EXHALE, m:'mouth'} 
      ],
      'box': [
          {t:"INHALA", b:4, y:'rise', c:C_INHALE, m:'nose'},
          {t:"MANT√âN", b:4, y:'hold_high', c:C_HOLD, m:'nose'},
          {t:"EXHALA", b:4, y:'fall', c:C_EXHALE, m:'nose'},
          {t:"SOST√âN", b:4, y:'hold_low', c:C_HOLD, m:'nose'}
      ],
      '5-5': [
          {t:"INHALA", b:5, y:'rise', c:C_INHALE, m:'nose'},
          {t:"EXHALA", b:5, y:'fall', c:C_EXHALE, m:'nose'}
      ]
    };
    
    // --- FRASES ZEN ---
    const pSubjects = [ "El r√≠o", "La brisa", "El bamb√∫", "La monta√±a", "Tu mente", "El ahora", "La hoja", "El agua", "Este aire", "La nube", "El vac√≠o", "La ra√≠z" ];
    const pActions = [ "fluye", "cede", "se dobla", "observa", "refleja", "existe", "suelta", "descansa", "sana", "pasa", "acoge", "crece" ];
    const pConclusions = [ "S√© agua.", "Paz.", "Calma.", "Centro.", "Nada m√°s.", "Serena.", "Simple.", "Aqu√≠.", "Conecta.", "Fluye.", "Amor.", "Luz." ];

    function getWuWeiQuote() {
        const s = pSubjects[Math.floor(Math.random() * pSubjects.length)];
        const a = pActions[Math.floor(Math.random() * pActions.length)];
        const c = pConclusions[Math.floor(Math.random() * pConclusions.length)];
        return `${s} ${a}. ${c}`;
    }

    // STATE: A√±adido music: true por defecto
    let state = { pk:null, data:[], dur:0, tempo:1.0, run:false, paused:false, startAudioTime:0, cyc:0, snd:false, met:false, quotesEnabled: true, music: true };
    
    let audioCtx = null;
    let nextNoteTime = 0.0;
    let currentBeatIndex = 0;
    let scheduleTimerID = null;
    const lookahead = 25.0; 
    const scheduleAheadTime = 0.1;

    // AUDIO AMBIENTAL
    const ambientAudio = new Audio('ambient.mp3');
    ambientAudio.loop = true;
    ambientAudio.volume = 0.5;

    // --- DOM REFERENCES ---
    const els = {
      menu: document.getElementById('selectionMenu'),
      sph: document.getElementById('sphere'), ph: document.getElementById('phaseText'),
      cnt: document.getElementById('counterText'), qt: document.getElementById('phraseContent'),
      cvs: document.getElementById('breathGraph'), ctx: document.getElementById('breathGraph').getContext('2d'),
      pat: document.getElementById('patternSteps'), badge: document.getElementById('patternBadge'),
      modeIcon: document.getElementById('modeIcon'),
      loading: document.getElementById('loadingOverlay')
    };

    // --- UTILS ---
    function formatPatternInput(input) {
        let raw = input.value.replace(/[^0-9bB]/g, '').toLowerCase();
        let formatted = '';
        for(let i=0; i < raw.length; i++) {
            const char = raw[i];
            if(/[0-9]/.test(char)) { if(formatted.length>0) formatted+='-'; formatted+=char; }
            else { if(formatted.length>0 && formatted.slice(-1)!=='b') formatted+=char; }
        }
        input.value = formatted;
    }
    const inputs = document.querySelectorAll('.big-input, .normal-input');
    inputs.forEach(el => el.addEventListener('input', (e) => formatPatternInput(e.target)));

    function toggleTooltip() {
        document.getElementById('inputTooltip').classList.toggle('visible');
    }

    // --- AUDIO SYSTEM ---
    function initAudio() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
    }

    function playTone(freq, type, dur, time) {
      if (!state.snd && !state.met) return; 
      try {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type; osc.frequency.setValueAtTime(freq, time);
        let vol = 0.0;
        if (state.snd) vol = 0.05; 
        if (state.met && type === 'square') vol = 0.05; 
        if (state.met && state.snd && type === 'square') vol = 0.08; 
        gain.gain.setValueAtTime(vol, time);
        gain.gain.exponentialRampToValueAtTime(0.001, time + dur);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(time); osc.stop(time + dur);
      } catch(e) {}
    }

    function scheduleNote(beatNumber, time) {
      if(state.paused) return;
      let accumulatedBeats = 0; let phase = null; let beatInPhase = 0;
      for (let p of state.data) {
        if (beatNumber < accumulatedBeats + p.b) { phase = p; beatInPhase = beatNumber - accumulatedBeats + 1; break; }
        accumulatedBeats += p.b;
      }
      if (phase) {
        if (beatInPhase === 1) { 
           let freq = 440;
           if(phase.y === 'rise') freq = 300; else if(phase.y === 'hold_high') freq = 450;
           else if(phase.y === 'fall') freq = 400; else freq = 250;
           playTone(freq, 'sine', 0.2, time);
        }
        if (state.met) playTone(beatInPhase === 1 ? 1200 : 800, 'square', 0.05, time); 
      }
    }

    function nextBeat() {
      if(state.paused) return; 
      const secondsPerBeat = state.tempo; nextNoteTime += secondsPerBeat; currentBeatIndex++; 
      const totalBeats = state.data.reduce((acc, p) => acc + p.b, 0);
      if (currentBeatIndex >= totalBeats) { 
          currentBeatIndex = 0; state.cyc++; 
          if(state.quotesEnabled) updateQuote();
      }
    }
    
    function updateQuote() { els.qt.innerHTML = getWuWeiQuote(); }

    function scheduler() {
      if (state.run) {
          if (!state.paused) {
              while (nextNoteTime < audioCtx.currentTime + scheduleAheadTime) {
                scheduleNote(currentBeatIndex, nextNoteTime); nextBeat();
              }
          } else { nextNoteTime = audioCtx.currentTime; }
          scheduleTimerID = setTimeout(scheduler, lookahead);
      }
    }

    // --- GRAPHICS & LOGIC ---
    function togglePause() {
        if(!state.run) return;
        state.paused = !state.paused;
        if(state.paused) {
            els.ph.textContent = "PAUSA"; els.ph.style.color = "#78909c";
            els.modeIcon.style.opacity = '0.5';
        } else { nextNoteTime = audioCtx.currentTime; }
    }

    function draw() {
      if (!state.run) return;
      if(state.paused) { requestAnimationFrame(draw); return; }

      const currentTime = audioCtx.currentTime;
      const elapsed = currentTime - state.startAudioTime;
      const totalCycleDur = state.dur;
      const cycleCountVisual = Math.floor(elapsed / totalCycleDur);
      
      const timeInCycle = elapsed % totalCycleDur;
      const p = state.data.find(x => timeInCycle >= x.start && timeInCycle < x.end);

      if (p) {
        if (els.ph.textContent !== p.t) { 
            els.ph.textContent = p.t; els.ph.style.color = p.c; 
            const isHold = (p.y.includes('hold'));
            els.modeIcon.textContent = isHold ? "‚è∏Ô∏è" : (p.m==='mouth'?"üå¨Ô∏è":"üëÉ");
            els.modeIcon.classList.add('visible');
        }
        els.sph.style.setProperty('--c-phase', p.c);
        
        // Highlight active step number
        const currentPhaseIdx = state.data.indexOf(p);
        const steps = document.querySelectorAll('.p-num');
        steps.forEach((el, idx) => {
            if(idx === currentPhaseIdx) el.classList.add('active');
            else el.classList.remove('active');
        });

        const timeInPhase = timeInCycle - p.start;
        let currentBeat = Math.floor(timeInPhase / state.tempo) + 1;
        currentBeat = Math.min(currentBeat, p.b);
        els.cnt.textContent = currentBeat;

        const progress = timeInPhase / p.dur; 
        const ease = -(Math.cos(Math.PI * progress) - 1) / 2;
        let maxScale = 1.45; 
        
        let rawScale = 1;
        if (p.y === 'rise') rawScale = 0.8 + ((maxScale - 0.8) * ease); 
        else if (p.y === 'fall') rawScale = maxScale - ((maxScale - 0.8) * ease);
        else if (p.y === 'hold_high') rawScale = maxScale; 
        else rawScale = 0.8;
        
        els.sph.style.transform = `scale(${rawScale})`;
      }

      // Canvas
      const w = els.cvs.width; const h = els.cvs.height;
      els.ctx.clearRect(0, 0, w, h);
      const centerX = w / 2; const trackY = h / 2; const trackH = 14; 
      const pxPerSec = w / (7 * state.tempo);

      // Draw future/past cycles
      for (let c = cycleCountVisual - 1; c <= cycleCountVisual + 1; c++) {
          const cycleStartTime = c * totalCycleDur;
          state.data.forEach(phase => {
              const pStartAbs = cycleStartTime + phase.start;
              const pEndAbs = cycleStartTime + phase.end;
              const xStart = centerX + (pStartAbs - elapsed) * pxPerSec;
              const xEnd = centerX + (pEndAbs - elapsed) * pxPerSec;
              if(xEnd < 0 || xStart > w) return;
              
              els.ctx.fillStyle = phase.c;
              els.ctx.fillRect(xStart, trackY - trackH/2, xEnd - xStart, trackH);
              
              // Beat markers
              els.ctx.strokeStyle = 'rgba(255,255,255,0.5)'; els.ctx.lineWidth = 1;
              for(let b = 1; b < phase.b; b++) {
                   const beatTimeAbs = pStartAbs + (b * state.tempo);
                   const markX = centerX + (beatTimeAbs - elapsed) * pxPerSec;
                   els.ctx.beginPath(); els.ctx.moveTo(markX, trackY - trackH/2); els.ctx.lineTo(markX, trackY + trackH/2); els.ctx.stroke();
              }
          });
      }
      // Center cursor
      els.ctx.beginPath(); els.ctx.fillStyle = '#fff'; els.ctx.arc(centerX, trackY, 5, 0, Math.PI*2); els.ctx.fill();
      
      requestAnimationFrame(draw);
    }

    function prepareData(k) {
      if(!patterns[k]) return false;
      state.pk = k; state.data = []; let acc = 0;
      patterns[k].forEach(x => { 
          const d = x.b * state.tempo; 
          state.data.push({...x, start:acc, end:acc+d, dur:d}); acc += d; 
      });
      state.dur = acc;
      return true;
    }

    function initCanvas() {
      if(!els.cvs) return; 
      const rect = els.cvs.getBoundingClientRect(); 
      els.cvs.width = rect.width; els.cvs.height = rect.height; 
    }

    function renderPatternBadge(k) {
      els.badge.textContent = k.toUpperCase();
      // Render steps below sphere
      els.pat.innerHTML = '';
      patterns[k].forEach((step, idx) => {
        const s = document.createElement('span'); s.className = 'p-num'; 
        s.textContent = step.b;
        if(step.m==='mouth') s.innerHTML += '<span class="p-mode-sub">b</span>';
        els.pat.appendChild(s);
        if(idx < patterns[k].length-1) {
            const sep = document.createElement('span'); sep.className = 'p-sep'; sep.textContent = '-';
            els.pat.appendChild(sep);
        }
      });
    }

    function start(k) {
      if (!prepareData(k)) return;
      
      // M√öSICA: Iniciar
      if(state.music) { ambientAudio.currentTime = 0; ambientAudio.play().catch(()=>{}); }

      initAudio(); renderPatternBadge(k);
      els.menu.style.opacity = '0'; setTimeout(()=>els.menu.style.display='none', 400);
      
      // Reset UI
      if(state.quotesEnabled) { els.qt.style.opacity = '1'; els.qt.textContent = "Inhala..."; }
      
      setTimeout(() => {
        initCanvas(); state.run = true; state.paused = false;
        state.startAudioTime = audioCtx ? audioCtx.currentTime : 0;
        nextNoteTime = state.startAudioTime;
        currentBeatIndex = 0; state.cyc = 0; 
        if(audioCtx) scheduler(); requestAnimationFrame(draw);
      }, 100);
    }

    function stop() {
      // M√öSICA: Pausar
      ambientAudio.pause();

      state.run = false; clearTimeout(scheduleTimerID);
      els.sph.style.transform = 'scale(0.8)'; els.ph.textContent = "LISTO"; els.ph.style.color = 'var(--accent)';
      els.modeIcon.classList.remove('visible'); els.cnt.textContent = ""; 
      els.menu.style.display = 'flex'; setTimeout(()=>els.menu.style.opacity='1',10);
      els.ctx.clearRect(0,0,els.cvs.width,els.cvs.height);
    }

    // --- TOGGLES ---
    function toggleBtnState(id, isActive) {
        const btn = document.getElementById(id);
        if(isActive) btn.classList.add('active'); else btn.classList.remove('active');
    }

    function toggleTempo() { 
      const t = [1.0, 1.5, 2.0]; const idx = t.indexOf(state.tempo); const next = t[(idx+1)%t.length];
      state.tempo = next; 
      const label = next===1.0?'‚ö°':(next===1.5?'üê¢':'üêå');
      document.getElementById('tempoBtn').innerText = label;
      if(state.run) start(state.pk); 
    }

    function toggleSound() { 
      state.snd=!state.snd; toggleBtnState('soundBtn', state.snd);
      if(state.snd && state.run) initAudio();
    }

    function toggleMetronome() { 
      state.met=!state.met; toggleBtnState('metronomeBtn', state.met);
    }

    function toggleQuotes() {
        state.quotesEnabled = !state.quotesEnabled; 
        toggleBtnState('quoteToggleBtn', state.quotesEnabled);
        els.qt.style.opacity = state.quotesEnabled ? '1' : '0';
    }

    function toggleMusic() {
        state.music = !state.music;
        toggleBtnState('musicBtn', state.music);
        if(state.music) { if(state.run) ambientAudio.play(); }
        else { ambientAudio.pause(); }
    }

    // --- SHARE SYSTEM ---
    function openCustomModal() { document.getElementById('customOverlay').style.display='flex'; }
    function openShareConfig() { document.getElementById('shareConfigOverlay').style.display='flex'; }
    
    function parsePatternStrFull(str) {
        const chunks = str.split('-');
        const defs = [ {t:"INHALA", y:'rise', c:C_INHALE}, {t:"MANT√âN", y:'hold_high', c:C_HOLD}, {t:"EXHALA", y:'fall', c:C_EXHALE}, {t:"SOST√âN", y:'hold_low', c:C_HOLD} ];
        return chunks.map((chunk, i) => {
            let beats = parseInt(chunk.replace(/\D/g,'')) || 4;
            let mode = chunk.toLowerCase().includes('b') ? 'mouth' : 'nose';
            let def = defs[i % defs.length];
            return { ...def, b: beats, m: mode };
        });
    }

    function startCustom() {
        const val = document.getElementById('customPatternInput').value.trim();
        if(!val) return;
        patterns['custom'] = parsePatternStrFull(val);
        document.getElementById('customOverlay').style.display='none';
        start('custom');
    }
    
    // --- SHARE LINK GENERATOR ---
    async function generateShareLink() {
       let pString = document.getElementById('customPatternInput').value.trim();
       if(!pString) pString = "4-7-8b"; // Default si est√° vac√≠o y viene de ConfigOverlay
       // Si venimos del shareConfig, usamos ese input si est√° relleno
       const pillInput = document.getElementById('pillNameInput').value;
       
       const n = document.getElementById('pillNameInput').value.trim() || 'Amigo';
       const m = document.getElementById('pillMessageInput').value.trim() || 'Respira conmigo...';
       
       // Si el input principal de custom tiene algo, usamos ese patr√≥n. Si no, usamos 4-7-8b por defecto
       const finalPattern = patterns['custom'] ? document.getElementById('customPatternInput').value : '4-7-8b';

       document.getElementById('shareConfigOverlay').style.display = 'none'; 
       els.loading.style.display = 'flex'; 
       
       const baseUrl = location.href.split('?')[0];
       const longUrl = `${baseUrl}?p=${encodeURIComponent(finalPattern)}&to=${encodeURIComponent(n)}&msg=${encodeURIComponent(m)}`;
       let finalUrl = longUrl;
       
       try { 
           const response = await fetch(`https://tinyurl.com/api-create.php?url=${encodeURIComponent(longUrl)}`);
           if(response.ok) finalUrl = await response.text(); 
       } catch(e) {}
       
       els.loading.style.display = 'none';
       document.getElementById('shareText').value = `üåø *P√≠ldora de Respiraci√≥n*\n${m}\n\nPrueba este ritmo: ${finalPattern}\n${finalUrl}`;
       document.getElementById('shareModal').style.display = 'flex';
    }

    function sendWhatsapp() { window.open(`https://wa.me/?text=${encodeURIComponent(document.getElementById('shareText').value)}`, '_blank'); }
    function copyToClipboard() {
      const copyText = document.getElementById("shareText");
      copyText.select(); copyText.setSelectionRange(0, 99999);
      navigator.clipboard.writeText(copyText.value).then(() => alert("¬°Copiado!"));
    }

    window.closePill = function() { 
        document.getElementById('pillOverlay').style.display='none'; 
        // Si hay patr√≥n en URL, arrancar
        const q = new URLSearchParams(location.search);
        if(q.get('p')) start(q.get('p'));
    }

    // --- INIT ---
    window.addEventListener('resize', initCanvas);
    initCanvas();
    els.loading.style.display = 'none';

    // CHECK URL PARAMS
    const q = new URLSearchParams(location.search);
    if(q.get('p')) {
        let pCode = q.get('p'); 
        const dynamicP = parsePatternStrFull(pCode);
        if(dynamicP.length >= 2) {
           patterns[pCode] = dynamicP; 
           document.getElementById('pillOverlay').style.display = 'flex';
           const recipient = q.get('to') || 'Ti';
           document.getElementById('pillRecipient').textContent = `Hola, ${recipient}`;
           document.getElementById('pillMessage').textContent = `"${q.get('msg') || '...'}"`;
           els.menu.style.display = 'none'; 
        }
    }

    // --- "SCRIPT ASESINO" DE SERVICE WORKER ---
    // Esto desinstalar√° cualquier versi√≥n anterior para solucionar el cach√©
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
            for(let registration of registrations) {
                console.log("Desinstalando SW antiguo:", registration);
                registration.unregister();
            }
        });
    }
  </script>
</body>
</html>
