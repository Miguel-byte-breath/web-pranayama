<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Respiraci√≥n Guiada: Web del Pranayama</title>
  <style>
    /* --- RESET Y BASE --- */
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #e8f4f8 50%, #f0f5f9 100%);
      color: #2c3e50;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      overflow: hidden;
      position: relative;
    }

    /* --- UI SUPERIOR --- */
    .ui-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      padding: 15px;
      pointer-events: none;
      z-index: 40;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      pointer-events: auto;
    }

    .cycle-counter {
      font-size: 0.95rem;
      background: rgba(255, 255, 255, 0.95);
      color: #2c3e50;
      padding: 8px 14px;
      border-radius: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid rgba(76, 175, 80, 0.2);
      font-weight: 600;
    }

    .controls-row {
      display: flex;
      justify-content: center;
      gap: 8px;
      pointer-events: auto;
      flex-wrap: wrap;
    }

    .btn, .tempo-selector {
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #cfd8dc;
      padding: 8px 12px;
      border-radius: 18px;
      font-size: 0.85rem;
      cursor: pointer;
      color: #455a64;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.2s ease;
    }

    .btn:active, .btn.active {
      background: #e8f5e9;
      color: #2e7d32;
      border-color: #4CAF50;
      transform: scale(0.98);
    }

    select {
      background: transparent;
      border: none;
      outline: none;
      font-weight: 700;
      color: #2e7d32;
      font-size: 0.9rem;
    }

    /* --- FRASE REFLEXIVA --- */
    .reflective-phrase {
      position: absolute;
      z-index: 15;
      color: #1a5f7a;
      font-weight: 500;
      font-style: italic;
      line-height: 1.4;
      opacity: 0.9;
      pointer-events: none;
      transition: opacity 0.5s ease;
      text-align: center;
      width: 85%;
      max-width: 600px;
      text-shadow: 0 0 15px rgba(255, 255, 255, 0.9), 0 0 5px rgba(255, 255, 255, 1);
    }

    /* --- ESFERA CENTRAL --- */
    .sphere-container {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
      margin-top: 2vh; 
      margin-bottom: 2vh;
      width: 100%;
    }

    .sphere {
      width: 180px;
      height: 180px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #a8ff60, #4CAF50);
      box-shadow: 0 10px 40px rgba(76, 175, 80, 0.4);
      transform: scale(1);
      margin-bottom: 50px; 
      z-index: 10;
      will-change: transform; 
    }

    .phase {
      font-size: 2rem;
      color: #1a5f7a;
      font-weight: 300;
      letter-spacing: 1px;
      min-height: 40px;
      position: relative;
      z-index: 20; 
      text-shadow: 0 0 20px rgba(255, 255, 255, 0.9), 0 0 10px rgba(255, 255, 255, 0.8);
      margin-top: -10px; 
    }

    .counter {
      font-size: 2.2rem;
      color: #4CAF50;
      font-weight: 700;
      min-height: 45px;
      position: relative;
      z-index: 20;
      text-shadow: 0 0 15px rgba(255, 255, 255, 1);
    }

    /* --- CANVAS Y VISUALIZADOR --- */
    .breath-visual {
      width: 92%;
      max-width: 600px;
      height: 120px;
      position: relative;
      margin-bottom: 5px; 
      z-index: 15; 
    }

    #breathGraph {
      width: 100%;
      height: 100%;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.5);
      box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    }
    
    .pattern-label-display {
      font-size: 1.1rem;
      color: #4CAF50;
      font-weight: 700;
      letter-spacing: 2px;
      text-align: center;
      margin-bottom: 20px;
      z-index: 15;
      position: relative;
      text-shadow: 0 1px 2px rgba(255,255,255,0.8);
      height: 25px; 
    }

    /* --- SELECTOR --- */
    .pattern-selector {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(255, 255, 255, 0.98);
      padding: 20px 15px 30px 15px;
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      box-shadow: 0 -5px 25px rgba(0,0,0,0.1);
      max-height: 50vh;
      overflow-y: auto;
      z-index: 50;
      display: block;
    }

    .pattern-option {
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 12px;
      background: #f9f9f9;
      cursor: pointer;
      border: 1px solid transparent;
      display: flex;
      flex-direction: column;
    }
    .pattern-option:hover { background: #f0f7f0; }
    .pattern-option.selected { background: #e8f5e9; border-color: #4CAF50; }
    .pattern-option .name { font-weight: 700; color: #2e7d32; font-size: 1rem; margin-bottom: 4px; }
    .pattern-option .description { font-size: 0.85rem; color: #546e7a; }

    /* --- ESTILOS MODO P√çLDORA (NUEVO) --- */
    #pillOverlay {
      background: rgba(255,255,255,0.98);
      backdrop-filter: blur(5px);
    }
    
    #startPillBtn {
      font-size: 1.1rem;
      padding: 15px 35px;
      background: #4CAF50;
      color: white;
      border: none;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      font-weight: 600;
    }
    #startPillBtn:active { transform: scale(0.95); }

    #shareBtn {
      position: fixed; 
      bottom: 20px; 
      right: 20px; 
      z-index: 60; 
      background: #1a5f7a; 
      color: white; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      font-weight: 600;
      padding: 12px 20px;
    }

    /* --- MEDIA QUERIES --- */
    @media (orientation: portrait) {
      .sphere {
        width: 45vw; height: 45vw;
        max-width: 180px; max-height: 180px;
        margin-bottom: 40px; 
      }
      .reflective-phrase {
        top: 135px; left: 50%; transform: translateX(-50%); font-size: 1rem;
      }
      .sphere-container { margin-top: 70px; }
    }

    @media (min-width: 768px) and (orientation: landscape) {
      .ui-layer { width: auto; right: 20px; left: auto; align-items: flex-end; }
      .top-row { justify-content: flex-end; gap: 15px; width: auto; }
      .controls-row { justify-content: flex-end; }
      .reflective-phrase {
        top: 50%; left: 5%; transform: translateY(-50%); text-align: left; 
        width: 30vw; font-size: 1.3rem;
        border-left: 4px solid rgba(76, 175, 80, 0.3); padding-left: 20px;
      }
      .pattern-selector {
        width: 350px; left: 50%; bottom: 20px; transform: translateX(-50%);
        border-radius: 15px;
      }
      .sphere-container { margin-top: 0; }
      .sphere { margin-bottom: 50px; }
    }
  </style>
</head>
<body>

  <div id="pillOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:100; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:20px;">
    <h1 style="color:#2e7d32; margin-bottom:10px; font-size: 2rem;">üçÉ Una pausa para ti</h1>
    <h2 id="pillRecipient" style="color:#1a5f7a; margin-bottom:20px; font-weight:400;"></h2>
    <p id="pillMessage" style="font-size:1.2rem; font-style:italic; color:#546e7a; margin-bottom:40px; max-width:500px; line-height: 1.5;"></p>
    <button id="startPillBtn" class="btn">Comenzar Ejercicio</button>
  </div>

  <div class="ui-layer">
    <div class="top-row">
      <div class="cycle-counter" id="cycleCounter">üîÑ Ciclos: 0</div>
      <button class="btn" id="resetBtn">‚Üª Reiniciar</button>
    </div>
    <div class="controls-row">
      <div class="tempo-selector">
        ‚è±Ô∏è
        <select id="tempoSelect">
          <option value="1000">1s</option>
          <option value="1500">1.5s</option>
          <option value="2000">2s</option>
        </select>
      </div>
      <button class="btn" id="soundBtn">üîá Sonido</button>
      <button class="btn" id="metronomeBtn">‚è±Ô∏è Metro</button>
    </div>
  </div>

  <div class="reflective-phrase" id="reflectivePhrase">
    <span id="phraseContent">Respira. El amor es tu verdadera naturaleza.</span>
  </div>

  <div class="sphere-container">
    <div class="sphere" id="sphere"></div>
    <div class="phase" id="phaseText">Elige patr√≥n</div>
    <div class="counter" id="counterText"></div>
  </div>

  <div class="breath-visual">
    <canvas id="breathGraph"></canvas>
  </div>
  
  <div class="pattern-label-display" id="patternLabelDisplay"></div>

  <button id="shareBtn" class="btn">üì§ Enviar P√≠ldora</button>

  <div class="pattern-selector" id="patternSelector">
    <h3 style="text-align:center; color:#2e7d32; margin-bottom:15px; font-size:1.1rem;">Selecciona Patr√≥n</h3>
    <div class="pattern-option" data-pattern="4-4-6-2">
      <div class="name">4-4-6-2 (Relajaci√≥n Profunda)</div>
      <div class="description">Inhala 4 ‚Ä¢ Mant√©n 4 ‚Ä¢ Exhala 6 ‚Ä¢ Sost√©n 2</div>
    </div>
    <div class="pattern-option" data-pattern="4-7-8">
      <div class="name">4-7-8 (Sue√±o)</div>
      <div class="description">Inhala 4 ‚Ä¢ Mant√©n 7 ‚Ä¢ Exhala 8</div>
    </div>
    <div class="pattern-option" data-pattern="box">
      <div class="name">Cuadrada (Enfoque)</div>
      <div class="description">In 4 ‚Ä¢ Mant 4 ‚Ä¢ Ex 4 ‚Ä¢ Sost 4</div>
    </div>
    <div class="pattern-option" data-pattern="5-5">
      <div class="name">5-5 (Coherencia)</div>
      <div class="description">Inhala 5 ‚Ä¢ Exhala 5</div>
    </div>
  </div>

  <script>
    /* --- CONFIGURACI√ìN --- */
    const patterns = {
      '4-4-6-2': [
        { text: "Inhala", beats: 4, type: 'rise' },
        { text: "Mant√©n", beats: 4, type: 'hold_high' },
        { text: "Exhala", beats: 6, type: 'fall' },
        { text: "Sost√©n", beats: 2, type: 'hold_low' }
      ],
      '4-7-8': [
        { text: "Inhala", beats: 4, type: 'rise' },
        { text: "Mant√©n", beats: 7, type: 'hold_high' },
        { text: "Exhala", beats: 8, type: 'fall' }
      ],
      'box': [
        { text: "Inhala", beats: 4, type: 'rise' },
        { text: "Mant√©n", beats: 4, type: 'hold_high' },
        { text: "Exhala", beats: 4, type: 'fall' },
        { text: "Sost√©n", beats: 4, type: 'hold_low' }
      ],
      '5-5': [
        { text: "Inhala", beats: 5, type: 'rise' },
        { text: "Exhala", beats: 5, type: 'fall' }
      ]
    };

    const REFLECTIVE_PHRASES = [
      "El amor no es algo que haces, es lo que eres.",
      "Ama lo que es. La resistencia solo trae dolor.",
      "Cuando la mente se detiene, la belleza del mundo se revela.",
      "No eres tus pensamientos. Eres el silencio detr√°s de ellos.",
      "Acepta este momento radicalmente. Aqu√≠ reside la paz.",
      "La belleza es el resplandor de la verdad.",
      "En el silencio del no-saber, el coraz√≥n encuentra descanso.",
      "S√© como el cielo: permite que pasen las nubes sin aferrarte.",
      "El amor incondicional es la aceptaci√≥n total de lo que es.",
      "Vuelve a casa, vuelve al ahora.",
      "Tu verdadera naturaleza es paz, amor y dicha.",
      "Observa sin juzgar. Eso es amor."
    ];

    /* --- VARIABLES DE ESTADO --- */
    let currentPatternKey = null;
    let currentPatternData = [];
    let startTime = 0;
    let totalCycleDuration = 0;
    let tempo = 1000;
    
    let isRunning = false;
    let animationFrameId = null;
    let cycles = 0;
    
    let soundOn = false;
    let metronomeOn = false;
    let audioCtx = null;
    let lastPhraseIdx = -1;
    let lastBeatPlayed = -1;

    // Canvas
    let canvas, ctx;
    let segments = [];

    /* --- ELEMENTOS DOM --- */
    const sphere = document.getElementById('sphere');
    const phaseText = document.getElementById('phaseText');
    const counterText = document.getElementById('counterText');
    const cycleCounter = document.getElementById('cycleCounter');
    const patternSelector = document.getElementById('patternSelector');
    const phraseEl = document.getElementById('phraseContent');
    const phraseContainer = document.getElementById('reflectivePhrase');
    const patternLabelDisplay = document.getElementById('patternLabelDisplay');

    /* --- FRASES ALEATORIAS --- */
    function setRandomPhrase() {
      let newIdx;
      do {
        newIdx = Math.floor(Math.random() * REFLECTIVE_PHRASES.length);
      } while (newIdx === lastPhraseIdx && REFLECTIVE_PHRASES.length > 1);
      lastPhraseIdx = newIdx;
      
      phraseContainer.style.opacity = 0;
      setTimeout(() => {
        phraseEl.textContent = REFLECTIVE_PHRASES[newIdx];
        phraseContainer.style.opacity = 0.9;
      }, 300);
    }

    /* --- AUDIO --- */
    function initAudio() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    function beep(freq = 440, type = 'sine', dur = 0.1) {
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = type;
      osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
      gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + dur);
    }

    /* --- MOTOR DE SINCRONIZACI√ìN --- */
    function recalculatePatternData() {
      if (!currentPatternKey) return;
      const patternDef = patterns[currentPatternKey];
      
      currentPatternData = [];
      let accumulatedTime = 0;
      
      patternDef.forEach(p => {
        const duration = p.beats * tempo;
        currentPatternData.push({
          ...p,
          startTime: accumulatedTime,
          endTime: accumulatedTime + duration,
          duration: duration
        });
        accumulatedTime += duration;
      });
      
      totalCycleDuration = accumulatedTime;
      calculateCanvasSegments();
    }

    function loop() {
      if (!isRunning) return;

      const now = Date.now();
      const elapsedTotal = now - startTime;
      const timeInCycle = elapsedTotal % totalCycleDuration;
      
      const currentCycle = Math.floor(elapsedTotal / totalCycleDuration);
      if (currentCycle > cycles) {
        cycles = currentCycle;
        cycleCounter.textContent = `üîÑ Ciclos: ${cycles}`;
      }

      const currentPhase = currentPatternData.find(p => timeInCycle >= p.startTime && timeInCycle < p.endTime);

      if (currentPhase) {
        if (phaseText.textContent !== currentPhase.text) {
             phaseText.textContent = currentPhase.text;
             if (soundOn) {
                let freq = 440;
                if(currentPhase.type === 'rise') freq = 300;
                if(currentPhase.type === 'hold_high') freq = 450;
                if(currentPhase.type === 'fall') freq = 400;
                if(currentPhase.type === 'hold_low') freq = 250;
                beep(freq, 'sine', 0.2);
             }
        }

        const timeInPhase = timeInCycle - currentPhase.startTime;
        const currentBeat = Math.floor(timeInPhase / tempo) + 1;
        counterText.textContent = currentBeat;

        const beatKey = `${cycles}-${currentPhase.text}-${currentBeat}`;
        if (metronomeOn && lastBeatPlayed !== beatKey) {
            beep(800, 'square', 0.05);
            lastBeatPlayed = beatKey;
        }

        const phaseProgress = timeInPhase / currentPhase.duration; 
        let scale = 1;

        if (currentPhase.type === 'rise') {
          scale = 1 + (0.5 * phaseProgress);
        } else if (currentPhase.type === 'fall') {
          scale = 1.5 - (0.5 * phaseProgress);
        } else if (currentPhase.type === 'hold_high') {
          scale = 1.5;
        } else {
          scale = 1;
        }
        
        sphere.style.transform = `scale(${scale})`;
      }

      drawCanvas(timeInCycle);

      animationFrameId = requestAnimationFrame(loop);
    }

    /* --- CANVAS --- */
    function initCanvas() {
      canvas = document.getElementById('breathGraph');
      ctx = canvas.getContext('2d');
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);
      
      calculateCanvasSegments();
    }

    function calculateCanvasSegments() {
      if (!canvas || !currentPatternData.length) return;
      
      const w = canvas.width / (window.devicePixelRatio || 1);
      const h = canvas.height / (window.devicePixelRatio || 1);
      const marginY = 20;
      
      segments = [];
      const totalBeats = currentPatternData.reduce((sum, p) => sum + p.beats, 0);
      const unitW = w / totalBeats;
      
      let startX = 0;
      let currentY = h - marginY; 

      currentPatternData.forEach(p => {
        const width = p.beats * unitW;
        const endX = startX + width;
        
        let endY = currentY;
        if (p.type === 'rise') endY = marginY;
        if (p.type === 'fall') endY = h - marginY;
        if (p.type === 'hold_high') endY = marginY;
        if (p.type === 'hold_low') endY = h - marginY;
        
        segments.push({
            startX, endX,
            startY: currentY, endY,
            startTime: p.startTime,
            endTime: p.endTime
        });
        
        startX = endX;
        currentY = endY;
      });
    }

    function drawCanvas(timeInCycle) {
      const w = canvas.width / (window.devicePixelRatio || 1);
      const h = canvas.height / (window.devicePixelRatio || 1);
      
      ctx.clearRect(0, 0, w, h);
      
      ctx.beginPath();
      ctx.strokeStyle = '#4CAF50';
      ctx.lineWidth = 4;
      ctx.lineJoin = 'round';
      ctx.lineCap = 'round';
      
      segments.forEach((seg, i) => {
        if (i === 0) ctx.moveTo(seg.startX, seg.startY);
        ctx.lineTo(seg.endX, seg.endY);
      });
      ctx.stroke();
      
      const activeSeg = segments.find(s => timeInCycle >= s.startTime && timeInCycle < s.endTime);
      
      if (activeSeg) {
          const segDuration = activeSeg.endTime - activeSeg.startTime;
          const progress = (timeInCycle - activeSeg.startTime) / segDuration;
          
          const ballX = activeSeg.startX + (activeSeg.endX - activeSeg.startX) * progress;
          const ballY = activeSeg.startY + (activeSeg.endY - activeSeg.startY) * progress;
          
          ctx.beginPath();
          ctx.fillStyle = '#FF5722';
          ctx.arc(ballX, ballY, 8, 0, Math.PI * 2);
          ctx.fill();
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 2;
          ctx.stroke();
      }
    }

    /* --- CONTROLES --- */
    function start(patternKey) {
      if (isRunning) stop();
      
      currentPatternKey = patternKey;
      
      // Actualizar el nombre num√©rico visible
      let displayName = patternKey;
      if (patternKey === 'box') displayName = '4-4-4-4'; // Traducci√≥n especial para BOX
      patternLabelDisplay.textContent = displayName;
      
      recalculatePatternData();
      
      patternSelector.style.display = 'none';
      cycleCounter.textContent = "üîÑ Ciclos: 0";
      
      initAudio();
      setRandomPhrase();
      
      setTimeout(() => {
        initCanvas();
        isRunning = true;
        startTime = Date.now();
        cycles = 0;
        lastBeatPlayed = -1;
        loop(); 
      }, 50);
    }

    function stop() {
      isRunning = false;
      cancelAnimationFrame(animationFrameId);
      
      sphere.style.transform = 'scale(1)';
      phaseText.textContent = "Elige patr√≥n";
      counterText.textContent = "";
      patternLabelDisplay.textContent = ""; 
      patternSelector.style.display = 'block';
      document.getElementById('shareBtn').style.display = 'block';

      if(ctx) {
         const w = canvas.width / (window.devicePixelRatio || 1);
         const h = canvas.height / (window.devicePixelRatio || 1);
         ctx.clearRect(0,0,w,h);
      }
      setRandomPhrase();
    }

    /* --- EVENTOS --- */
    document.querySelectorAll('.pattern-option').forEach(el => {
      el.addEventListener('click', () => {
        document.querySelectorAll('.pattern-option').forEach(o => o.classList.remove('selected'));
        el.classList.add('selected');
        start(el.dataset.pattern);
      });
    });

    document.getElementById('resetBtn').addEventListener('click', stop);
    
    document.getElementById('soundBtn').addEventListener('click', function() {
      soundOn = !soundOn;
      this.classList.toggle('active');
      this.textContent = soundOn ? "üîä ON" : "üîá Sonido";
      initAudio();
    });

    document.getElementById('metronomeBtn').addEventListener('click', function() {
      metronomeOn = !metronomeOn;
      this.classList.toggle('active');
    });

    document.getElementById('tempoSelect').addEventListener('change', function() {
      tempo = parseInt(this.value);
      if (isRunning) {
        recalculatePatternData();
        startTime = Date.now(); 
        lastBeatPlayed = -1;
      }
    });

    window.addEventListener('resize', () => {
      if (isRunning) {
          initCanvas();
      }
    });

    setRandomPhrase();
    
    /* -----------------------------------------------------
       M√ìDULO DE P√çLDORAS WEB: GESTI√ìN DE URL Y COMPARTIR
       ----------------------------------------------------- */

    // 1. Leer par√°metros URL
    function getQueryParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        pattern: params.get('p'),      
        to: params.get('para'),        
        msg: params.get('msg')         
      };
    }

    // 2. Inicializaci√≥n inteligente
    window.addEventListener('DOMContentLoaded', () => {
      const params = getQueryParams();

      if (params.pattern && patterns[params.pattern]) {
        // MODO P√çLDORA (El usuario viene de un enlace compartido)
        const overlay = document.getElementById('pillOverlay');
        const recipientEl = document.getElementById('pillRecipient');
        const msgEl = document.getElementById('pillMessage');
        const startBtn = document.getElementById('startPillBtn');
        const shareBtn = document.getElementById('shareBtn');

        // Configurar la interfaz
        patternSelector.style.display = 'none'; // Ocultar selector
        shareBtn.style.display = 'none';        // Ocultar bot√≥n de crear p√≠ldora al receptor
        
        const name = params.to ? params.to : "Alguien";
        recipientEl.textContent = `Hola, ${name}`;
        msgEl.textContent = params.msg ? `"${params.msg}"` : '"T√≥mate un momento para respirar."';

        // Mostrar pantalla de bienvenida
        overlay.style.display = 'flex';

        // Al hacer clic, iniciamos todo (necesario para activar AudioContext)
        startBtn.addEventListener('click', () => {
          overlay.style.display = 'none';
          
          if (params.msg) {
            phraseEl.textContent = params.msg;
            lastPhraseIdx = -999; // Evitar que cambie la frase
          }
          
          start(params.pattern);
        });

      } else {
        // MODO NORMAL (Sin par√°metros)
        // Se muestra la UI est√°ndar
      }
    });

    // 3. Bot√≥n para Generar y Compartir P√≠ldora
    document.getElementById('shareBtn').addEventListener('click', () => {
      const pattern = prompt("¬øQu√© ejercicio quieres enviar? (Escribe: 4-7-8, box, 5-5, o 4-4-6-2)", "4-7-8");
      
      if (!patterns[pattern]) {
        alert("Patr√≥n no v√°lido. Por favor usa uno de la lista.");
        return;
      }

      const name = prompt("¬øPara qui√©n es?", "Amigo");
      const message = prompt("Escribe una dedicatoria corta:", "Respira y suelta el estr√©s...");

      // Construcci√≥n din√°mica de la URL
      const baseUrl = window.location.href.split('?')[0];
      const finalUrl = `${baseUrl}?p=${pattern}&para=${encodeURIComponent(name || 'Amigo')}&msg=${encodeURIComponent(message || 'Respira')}`;

      const whatsappText = `Hola ${name}, te mando una p√≠ldora de respiraci√≥n: "${message}". Entra aqu√≠: ${finalUrl}`;
      
      // Intentar copiar al portapapeles
      navigator.clipboard.writeText(whatsappText).then(() => {
        alert("¬°Enlace copiado al portapapeles!\n\nP√©galo ahora en WhatsApp.");
      }).catch(err => {
        // Fallback si falla el copiado autom√°tico
        prompt("Copia este enlace:", whatsappText);
      });
    });

  </script>
</body>
</html>
