<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Respira | Tu Espacio de Calma</title>
  
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="theme-color" content="#eefcfd">
  <meta name="description" content="Una aplicaci√≥n minimalista para respirar, relajarse y leer.">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;700&family=Manrope:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    /* --- 1. BASE & VARIABLES --- */
    :root {
      --dune-light: #eefcfd;
      --dune-mid: #e0f7fa;
      --text-main: #37474f;
      --text-sub: #78909c;
      --accent: #4CAF50; 
      --bg-gradient: linear-gradient(135deg, #eefcfd 0%, #e0f7fa 100%);
      --shadow-soft: 0 10px 30px rgba(0,0,0,0.05);
      --font-display: 'Cinzel', serif;
      --font-body: 'Manrope', sans-serif;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0; padding: 0;
      width: 100%; height: 100vh;
      overflow: hidden; 
      background: var(--bg-gradient);
      font-family: var(--font-body);
      color: var(--text-main);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: background 0.5s ease;
    }

    /* --- 2. LAYOUT & TOP CONTROLS --- */
    /* Posici√≥n absoluta para no empujar el contenido central */
    .top-right {
      position: absolute;
      top: 2rem;
      right: 2rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      z-index: 50;
    }

    .icon-btn {
      background: none; border: none; cursor: pointer; padding: 0;
      color: var(--text-main); opacity: 0.4; transition: all 0.3s ease;
      display: flex; align-items: center; justify-content: center;
    }
    .icon-btn:hover { opacity: 0.7; transform: translateY(-1px); }
    .icon-btn.active { opacity: 1; color: var(--accent); transform: scale(1.1); }
    .icon-btn svg { width: 24px; height: 24px; display: block; }

    /* --- 3. MAIN SPHERE --- */
    .sphere-container {
      position: relative;
      width: 280px; height: 280px;
      display: flex; align-items: center; justify-content: center;
      /* Margen inferior para separarlo de las frases */
      margin-bottom: 2rem;
      z-index: 5;
    }
    .sphere {
      width: 100%; height: 100%;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.8), rgba(255,255,255,0.1));
      box-shadow: 
        inset 0 0 20px rgba(255,255,255,0.5),
        0 10px 40px rgba(76, 175, 80, 0.2); 
      transform: scale(0.8);
      transition: transform 0.1s linear, box-shadow 0.5s ease;
      position: relative;
      z-index: 2;
      --c-phase: var(--accent);
    }
    .sphere::after {
      content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      border-radius: 50%; z-index: -1;
      box-shadow: 0 0 0 0 var(--c-phase);
      opacity: 0.6;
      animation: pulseShadow 4s infinite; 
      transition: box-shadow 0.5s ease;
    }

    /* --- 4. TEXT & UI ELEMENTS --- */
    .phase-text {
      position: absolute; 
      font-family: var(--font-display);
      font-size: 1.5rem; font-weight: 700;
      color: var(--accent);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      pointer-events: none; z-index: 10;
      text-shadow: 0 2px 10px rgba(255,255,255,0.8);
    }
    
    .counter-text {
      position: absolute; top: 65%;
      font-family: var(--font-body);
      font-size: 3rem; font-weight: 300;
      color: var(--text-main); opacity: 0.8;
      pointer-events: none; z-index: 10;
    }

    .info-bar {
      position: absolute; bottom: -60px;
      display: flex; gap: 1.5rem;
      font-size: 0.9rem; color: var(--text-sub);
      font-weight: 600; opacity: 0.8;
    }
    .info-item { display: flex; align-items: center; gap: 0.4rem; }
    .mode-icon { opacity: 0; transition: opacity 0.3s ease; font-size: 1.1rem; }
    .mode-icon.visible { opacity: 1; }

    /* Frases Zen - CORREGIDO */
    /* Usamos bottom: 140px para asegurar que NO toque el canvas (que mide 120px) */
    .zen-quote {
      position: absolute; 
      bottom: 140px; 
      width: 90%; 
      text-align: center;
      font-family: var(--font-display); font-size: 1rem; color: var(--text-main);
      opacity: 0; transition: opacity 1s ease; line-height: 1.6;
      z-index: 20;
    }
    
    /* --- 5. VISUALIZER (CANVAS) --- */
    .breath-track {
      position: absolute; bottom: 0; left: 0; width: 100%; height: 120px;
      z-index: 1; pointer-events: none; opacity: 0.4;
    }

    /* --- 6. MENUS & OVERLAYS --- */
    .selection-menu {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(238, 252, 253, 0.95);
      backdrop-filter: blur(10px);
      z-index: 100;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: opacity 0.4s ease;
    }
    .menu-title { font-family: var(--font-display); font-size: 2rem; margin-bottom: 2rem; color: var(--text-main); text-align: center; }
    .pattern-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; width: 90%; max-width: 400px; }
    .pattern-btn {
      background: #fff; border: 1px solid rgba(0,0,0,0.05); padding: 1.2rem; border-radius: 16px;
      font-family: var(--font-body); font-weight: 600; font-size: 1rem; color: var(--text-main);
      box-shadow: 0 4px 12px rgba(0,0,0,0.03); cursor: pointer; transition: all 0.2s ease;
      display: flex; flex-direction: column; align-items: center; gap: 0.5rem; position: relative;
    }
    .pattern-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); border-color: var(--accent); }
    .pattern-desc { font-size: 0.75rem; color: var(--text-sub); font-weight: 400; text-align: center; }
    
    .info-icon { position: absolute; top: 8px; right: 8px; font-size: 0.8rem; color: #b0bec5; cursor: help; }
    .info-tooltip { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #37474f; color: #fff; padding: 0.5rem; border-radius: 8px; font-size: 0.75rem; width: 180px; text-align: center; pointer-events: none; opacity: 0; transition: opacity 0.2s; z-index: 30; margin-bottom: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .info-tooltip.visible { opacity: 1; }

    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 200; display: none; align-items: center; justify-content: center; }
    .modal { background: #fff; padding: 2rem; border-radius: 20px; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    .modal h3 { margin-top: 0; font-family: var(--font-display); color: var(--text-main); }
    .custom-input { width: 100%; padding: 0.8rem; margin: 1rem 0; border: 2px solid #e0f7fa; border-radius: 12px; font-family: var(--font-body); font-size: 1.2rem; text-align: center; outline: none; color: var(--text-main); }
    .custom-input:focus { border-color: var(--accent); }
    .action-btn { background: var(--accent); color: #fff; border: none; padding: 0.8rem 2rem; border-radius: 50px; font-weight: 700; cursor: pointer; font-size: 1rem; transition: transform 0.2s; margin-top: 0.5rem; }
    .action-btn:active { transform: scale(0.95); }
    .close-btn { background: transparent; color: var(--text-sub); border: none; margin-top: 1rem; cursor: pointer; font-size: 0.9rem; text-decoration: underline; }

    .install-btn { position: absolute; bottom: 2rem; background: #37474f; color: #fff; padding: 0.6rem 1.2rem; border-radius: 30px; border: none; font-weight: 600; cursor: pointer; display: none; align-items: center; gap: 0.5rem; font-size: 0.9rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); z-index: 25; }

    /* Patr√≥n arriba a la izquierda (Asegurado absolute) */
    .pattern-display {
      position: absolute; top: 2rem; left: 2rem;
      font-family: var(--font-body); font-weight: 800; font-size: 1.2rem;
      color: var(--text-main); opacity: 0.3; letter-spacing: 2px;
      display: flex; gap: 4px; z-index: 10;
    }
    .p-num { transition: color 0.3s; position: relative; }
    .p-num.active { color: var(--accent); opacity: 1; transform: scale(1.1); }
    .p-mode-sub { font-size: 0.6em; vertical-align: sub; margin-left: 1px; opacity: 0.7; }
    .p-sep { opacity: 0.3; }

    .pill-form { display: flex; flex-direction: column; gap: 0.8rem; text-align: left; }
    .pill-label { font-size: 0.8rem; font-weight: 600; color: var(--text-sub); margin-left: 4px; margin-bottom: -4px; }
    .pill-input { width: 100%; padding: 0.6rem; border: 1px solid #e0e0e0; border-radius: 8px; font-family: var(--font-body); outline: none; font-size: 0.95rem; }
    .pill-input:focus { border-color: var(--accent); }
    .pill-buttons { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
    .btn-secondary { background: #eceff1; color: var(--text-main); flex: 1; }
    .btn-primary { background: var(--accent); color: white; flex: 2; }

    .loading-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); z-index: 300; display: none; align-items: center; justify-content: center; flex-direction: column; gap: 1rem; color: var(--accent); font-weight: 600; }

    @media (max-width: 768px) {
      .sphere-container { width: 240px; height: 240px; }
      .counter-text { font-size: 2.5rem; }
      /* Ajuste fino para m√≥viles */
      .top-right { top: 1.5rem; right: 1.5rem; gap: 0.5rem; } 
      .pattern-display { top: 1.5rem; left: 1.5rem; font-size: 1rem; }
      .menu-title { font-size: 1.5rem; }
      .pattern-grid { grid-template-columns: 1fr; }
      /* Aseguramos que la frase no baje demasiado en m√≥viles */
      .zen-quote { width: 90%; font-size: 0.9rem; bottom: 140px; }
    }
    
    @keyframes pulseShadow {
      0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4); }
      70% { box-shadow: 0 0 0 20px rgba(76, 175, 80, 0); }
      100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
    }
  </style>
</head>
<body>

  <button id="installBtn" class="install-btn" onclick="installApp()">‚¨á Instalar App</button>
  
  <div id="patternDisplay" class="pattern-display">4-7-8</div>

  <div class="top-right">
      <button id="quoteToggleBtn" class="icon-btn active" onclick="toggleQuotes()" aria-label="Frases">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
          <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
        </svg>
      </button>

      <button id="tempoBtn" class="icon-btn" onclick="toggleTempo()" aria-label="Tempo" style="font-size: 13px; font-weight: 700; width: auto; padding: 0 4px;">
        ‚ö° 1x
      </button>

      <button id="metronomeBtn" class="icon-btn" onclick="toggleMetronome()" aria-label="Metr√≥nomo">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 18v-6"></path>
          <path d="M10 2h4"></path> 
          <path d="M5 22h14"></path>
          <path d="M12 2v3"></path>
        </svg>
      </button>

      <button id="soundBtn" class="icon-btn active" onclick="toggleSound()" aria-label="Sonido">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 8a6 6 0 0 0-12 0c0 7-3 9-3 9h18s-3-2-3-9"></path>
          <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        </svg>
      </button>

      <button id="btnMusic" class="icon-btn active" onclick="toggleMusic()" aria-label="M√∫sica">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
           <path d="M9 18V5l12-2v13"></path>
           <circle cx="6" cy="18" r="3"></circle>
           <circle cx="18" cy="16" r="3"></circle>
        </svg>
      </button>
  </div>

  <div class="sphere-container">
    <div id="sphere" class="sphere"></div>
    <div id="phaseText" class="phase-text">LISTO</div>
    <div id="counterText" class="counter-text"></div>
    <div class="info-bar">
        <div class="info-item"><span id="cycleBadge">üîÑ 0</span></div>
        <div class="info-item"><span id="modeIcon" class="mode-icon">üëÉ</span></div>
    </div>
  </div>

  <div id="phraseContent" class="zen-quote">Sigue el ritmo, respira, nada m√°s.</div>
  <canvas id="breathGraph" class="breath-track" width="600" height="120"></canvas>

  <div id="selectionMenu" class="selection-menu">
    <div class="menu-title">Elige tu Ritmo</div>
    <div class="pattern-grid">
      <div class="pattern-btn" onclick="start('4-7-8b')">
         <span>üåô Relajaci√≥n</span>
         <span class="pattern-desc">4-7-8 (Boca) ¬∑ Dormir</span>
         <div class="info-icon" onclick="event.stopPropagation(); toggleTooltip(this)">‚Ñπ<div class="info-tooltip">Inhala 4s (Nariz)<br>Mant√©n 7s<br>Exhala 8s (Boca)<br>Ideal para ansiedad y sue√±o.</div></div>
      </div>
      <div class="pattern-btn" onclick="start('4-4-6-2')">
         <span>üßò‚Äç‚ôÇÔ∏è Calma Profunda</span>
         <span class="pattern-desc">4-4-6-2 ¬∑ Estr√©s</span>
         <div class="info-icon" onclick="event.stopPropagation(); toggleTooltip(this)">‚Ñπ<div class="info-tooltip">Inhala 4s, Mant√©n 4s,<br>Exhala 6s, Vac√≠o 2s.<br>Equilibra el sistema nervioso.</div></div>
      </div>
      <div class="pattern-btn" onclick="start('box')">
         <span>üì¶ Box Breathing</span>
         <span class="pattern-desc">4-4-4-4 ¬∑ Enfoque</span>
         <div class="info-icon" onclick="event.stopPropagation(); toggleTooltip(this)">‚Ñπ<div class="info-tooltip">4s en cada fase.<br>Usada por Navy SEALs<br>para concentraci√≥n m√°xima.</div></div>
      </div>
      <div class="pattern-btn" onclick="start('5-5')">
         <span>‚öñÔ∏è Coherencia</span>
         <span class="pattern-desc">5-5 ¬∑ Equilibrio</span>
         <div class="info-icon" onclick="event.stopPropagation(); toggleTooltip(this)">‚Ñπ<div class="info-tooltip">Respiraci√≥n resonante.<br>Sincroniza coraz√≥n y cerebro.<br>Perfecto para empezar.</div></div>
      </div>
    </div>
    <div style="margin-top: 2rem; display: flex; gap: 1rem;">
        <button onclick="openCustomModal()" style="background:none; border:none; color:var(--text-sub); font-weight:600; cursor:pointer; font-size:0.9rem;">‚ú® Crear Propio</button>
        <button onclick="openShareConfig()" style="background:none; border:none; color:var(--text-sub); font-weight:600; cursor:pointer; font-size:0.9rem;">üéÅ Enviar P√≠ldora</button>
    </div>
  </div>

  <div id="customOverlay" class="overlay">
      <div class="modal">
          <h3>Tu Ritmo</h3>
          <p style="font-size:0.9rem; color:#666;">Formato: Inhala-Mant√©n-Exhala...<br>Usa 'b' para boca (ej: 4-7-8b)</p>
          <input type="text" id="customPatternInput" class="custom-input" placeholder="Ej: 4-4-4-4">
          <button class="action-btn" onclick="startCustom()">Empezar</button>
          <button class="close-btn" onclick="document.getElementById('customOverlay').style.display='none'">Cancelar</button>
      </div>
  </div>

  <div id="shareConfigOverlay" class="overlay">
      <div class="modal">
          <h3>Crear P√≠ldora üíä</h3>
          <div class="pill-form">
              <div><label class="pill-label">Patr√≥n</label><input type="text" id="pillPatternInput" class="pill-input" placeholder="Ej: 4-7-8b"></div>
              <div><label class="pill-label">Para</label><input type="text" id="pillNameInput" class="pill-input" placeholder="Ej: Mam√°"></div>
              <div><label class="pill-label">Mensaje</label><textarea id="pillMessageInput" class="pill-input" rows="2" placeholder="Ej: T√≥mate 1 minuto..."></textarea></div>
          </div>
          <button class="action-btn" onclick="generateShareLink()" style="margin-top:1rem; width:100%;">Generar Enlace</button>
          <button class="close-btn" onclick="document.getElementById('shareConfigOverlay').style.display='none'">Cancelar</button>
      </div>
  </div>

  <div id="shareModal" class="overlay">
      <div class="modal">
          <h3>¬°P√≠ldora Lista! üíä</h3>
          <p style="font-size:0.9rem; margin-bottom:1rem;">Comparte este enlace:</p>
          <textarea id="shareText" style="width:100%; height:80px; padding:0.5rem; border:1px solid #ddd; border-radius:8px; font-size:0.8rem;"></textarea>
          <div class="pill-buttons">
              <button class="action-btn btn-primary" onclick="sendWhatsapp()">WhatsApp</button>
              <button class="action-btn btn-secondary" onclick="copyToClipboard()">Copiar</button>
          </div>
          <button class="close-btn" onclick="document.getElementById('shareModal').style.display='none'">Cerrar</button>
      </div>
  </div>

  <div id="pillOverlay" class="overlay" style="background: var(--bg-gradient); z-index: 100;">
      <div class="modal" style="background: rgba(255,255,255,0.95); max-width: 400px;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">üíä</div>
          <h3 id="pillRecipient" style="font-size: 1.5rem;">Hola...</h3>
          <p id="pillMessage" style="font-style: italic; color: #555; margin: 1.5rem 0; font-size: 1.1rem;">"..."</p>
          <button class="action-btn" onclick="window.closePill()">Recibir P√≠ldora</button>
      </div>
  </div>

  <div id="loadingOverlay" class="loading-overlay">
      <div class="sphere" style="width: 50px; height: 50px; animation: none; transform: scale(1);"></div>
      <span>Creando enlace...</span>
  </div>

  <script>
    // --- VARIABLES Y CONFIGURACI√ìN ---
    const C_INHALE = '#4CAF50'; 
    const C_HOLD   = '#FF9800'; 
    const C_EXHALE = '#2196F3'; 

    let patterns = {
      '4-4-6-2': [ {t:"INHALA", b:4, y:'rise', c:C_INHALE, m:'nose'}, {t:"MANT√âN", b:4, y:'hold_high', c:C_HOLD, m:'nose'}, {t:"EXHALA", b:6, y:'fall', c:C_EXHALE, m:'nose'}, {t:"SOST√âN", b:2, y:'hold_low', c:C_HOLD, m:'nose'} ],
      '4-7-8b': [ {t:"INHALA", b:4, y:'rise', c:C_INHALE, m:'nose'}, {t:"MANT√âN", b:7, y:'hold_high', c:C_HOLD, m:'nose'}, {t:"EXHALA", b:8, y:'fall', c:C_EXHALE, m:'mouth'} ],
      'box': [ {t:"INHALA", b:4, y:'rise', c:C_INHALE, m:'nose'}, {t:"MANT√âN", b:4, y:'hold_high', c:C_HOLD, m:'nose'}, {t:"EXHALA", b:4, y:'fall', c:C_EXHALE, m:'nose'}, {t:"SOST√âN", b:4, y:'hold_low', c:C_HOLD, m:'nose'} ],
      '5-5': [ {t:"INHALA", b:5, y:'rise', c:C_INHALE, m:'nose'}, {t:"EXHALA", b:5, y:'fall', c:C_EXHALE, m:'nose'} ]
    };
    
    // --- FRASES ZEN ---
    const pSubjects = [ "El r√≠o antiguo", "La brisa suave", "El bamb√∫ flexible", "La monta√±a quieta", "Tu mente clara", "El momento presente", "La hoja seca", "El agua profunda", "Este aliento", "La nube blanca", "El vac√≠o f√©rtil", "La ra√≠z fuerte", "El amor inmenso", "La belleza oculta", "Tu coraz√≥n sabio", "La flor del alma", "La luz interior" ];
    const pActions = [ "fluye sin esfuerzo", "no opone resistencia", "se dobla sin romperse", "observa en silencio", "refleja el cielo", "encuentra su camino", "suelta el control", "descansa en paz", "existe sin m√°s", "acepta el cambio", "danza con el viento", "crece despacio", "abraza lo que es", "florece sin prisa", "sana las heridas", "irradia calidez", "ama sin apego", "ve la verdad" ];
    const pConclusions = [ "S√© como el agua.", "Todo es perfecto.", "Paz infinita.", "Vuelve al centro.", "Nada que hacer.", "Mente serena.", "Simple y puro.", "Aqu√≠ y ahora.", "Conecta contigo.", "Fluye con todo.", "Amor es todo.", "Belleza pura.", "Eres el amor.", "Suelta y conf√≠a.", "Eres suficiente.", "Luz radiante." ];
    const masterQuotes = [ "El vac√≠o es forma, la forma es vac√≠o.", "Si te doblas como el junco, el viento no te romper√°.", "El viaje de mil millas comienza con un aliento.", "Conoce lo blanco, pero conserva lo negro.", "S√© el valle del universo, rec√≠belo todo.", "Poco a poco, el barro se asienta y el agua se aclara.", "Haz nada, y nada quedar√° sin hacer.", "El amor no reclama posesi√≥n, sino que da libertad.", "La belleza no est√° en el rostro, sino en la luz del coraz√≥n.", "Aceptar es el verdadero acto de transformaci√≥n." ];

    function getWuWeiQuote() {
        if(Math.random() < 0.3) { return masterQuotes[Math.floor(Math.random() * masterQuotes.length)]; } 
        else {
            const s = pSubjects[Math.floor(Math.random() * pSubjects.length)];
            const a = pActions[Math.floor(Math.random() * pActions.length)];
            const c = pConclusions[Math.floor(Math.random() * pConclusions.length)];
            return `${s} ${a}. ${c}`;
        }
    }

    // STATE: music activado por defecto
    let state = { pk:null, data:[], dur:0, tempo:1.0, run:false, paused:false, startAudioTime:0, cyc:0, snd:true, met:false, quotesEnabled: true, music: true };
    
    let audioCtx = null;
    let nextNoteTime = 0.0;
    let currentBeatIndex = 0;
    let scheduleTimerID = null;
    const lookahead = 25.0; 
    const scheduleAheadTime = 0.1;

    // AUDIO AMBIENTAL
    const ambientAudio = new Audio('ambient.mp3');
    ambientAudio.loop = true;
    ambientAudio.volume = 0.5;

    // DOM REFERENCES (IDs sincronizados con el HTML)
    const els = {
      menu: document.getElementById('selectionMenu'),
      sph: document.getElementById('sphere'), ph: document.getElementById('phaseText'),
      cnt: document.getElementById('counterText'), qt: document.getElementById('phraseContent'),
      cvs: document.getElementById('breathGraph'), ctx: document.getElementById('breathGraph').getContext('2d'),
      cyc: document.getElementById('cycleBadge'), pat: document.getElementById('patternDisplay'),
      load: document.getElementById('loadingOverlay'), shareModal: document.getElementById('shareModal'),
      shareText: document.getElementById('shareText'), customOverlay: document.getElementById('customOverlay'),
      customInput: document.getElementById('customPatternInput'), shareConfigOverlay: document.getElementById('shareConfigOverlay'),
      pillPatternInput: document.getElementById('pillPatternInput'), pillNameInput: document.getElementById('pillNameInput'),
      pillMessageInput: document.getElementById('pillMessageInput'), modeIcon: document.getElementById('modeIcon')
    };

    function formatPatternInput(input) {
        let raw = input.value.replace(/[^0-9bB]/g, '').toLowerCase();
        let formatted = '';
        for(let i=0; i < raw.length; i++) {
            const char = raw[i];
            if (/[0-9]/.test(char)) { if (formatted.length > 0) formatted += '-'; formatted += char; } 
            else { if (formatted.length > 0 && formatted.slice(-1) !== 'b') formatted += char; }
        }
        input.value = formatted;
    }
    if(els.customInput) els.customInput.addEventListener('input', (e) => formatPatternInput(e.target));
    if(els.pillPatternInput) els.pillPatternInput.addEventListener('input', (e) => formatPatternInput(e.target));

    window.toggleTooltip = function(el) { const tip = el.querySelector('.info-tooltip'); if(tip) tip.classList.toggle('visible'); }
    
    let deferredPrompt;
    const installBtn = document.getElementById('installBtn');
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; installBtn.style.display = 'flex'; });
    async function installApp() { if (deferredPrompt) { deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; } else { alert("Para instalar: Usa el men√∫ del navegador 'A√±adir a inicio'."); } }

    function openCustomModal() { els.customOverlay.style.display = 'flex'; els.customInput.value = ''; els.customInput.focus(); }

    function parsePatternString(str) {
        const chunks = str.split('-');
        const defs = [ {t:"INHALA", y:'rise', c:C_INHALE}, {t:"MANT√âN", y:'hold_high', c:C_HOLD}, {t:"EXHALA", y:'fall', c:C_EXHALE}, {t:"SOST√âN", y:'hold_low', c:C_HOLD}, {t:"PAUSA", y:'hold_low', c:C_HOLD} ];
        let newPattern = [];
        chunks.forEach((chunk, i) => {
            let beats = parseInt(chunk.replace(/\D/g,''));
            if(!isNaN(beats) && beats > 0) {
                let mode = 'nose'; if(chunk.toLowerCase().includes('b')) mode = 'mouth';
                let defIdx = i % defs.length;
                newPattern.push({ t: defs[defIdx].t, b: beats, y: defs[defIdx].y, c: defs[defIdx].c, m: mode });
            }
        });
        return newPattern;
    }

    function startCustom() {
        const val = els.customInput.value.trim();
        const newPattern = parsePatternString(val);
        if (newPattern.length < 2) { alert("Introduce al menos 2 fases v√°lidas."); return; }
        patterns['custom'] = newPattern; els.customOverlay.style.display = 'none'; start('custom');
    }

    function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{}); }

    function playTone(freq, type, dur, time) {
      if (!state.snd && !state.met) return; 
      try {
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.type = type; osc.frequency.setValueAtTime(freq, time);
        let vol = 0.0;
        if (state.snd) vol = 0.05; 
        if (state.met && type === 'square') vol = 0.05; 
        if (state.met && state.snd && type === 'square') vol = 0.08; 
        gain.gain.setValueAtTime(vol, time); gain.gain.exponentialRampToValueAtTime(0.001, time + dur);
        osc.connect(gain); gain.connect(audioCtx.destination); osc.start(time); osc.stop(time + dur);
      } catch(e) {}
    }

    function scheduleNote(beatNumber, time) {
      if(state.paused) return;
      let accumulatedBeats = 0; let phase = null; let beatInPhase = 0;
      for (let p of state.data) {
        if (beatNumber < accumulatedBeats + p.b) { phase = p; beatInPhase = beatNumber - accumulatedBeats + 1; break; }
        accumulatedBeats += p.b;
      }
      if (phase) {
        if (beatInPhase === 1) { 
           let freq = 440;
           if(phase.y === 'rise') freq = 300; else if(phase.y === 'hold_high') freq = 450; else if(phase.y === 'fall') freq = 400; else freq = 250;
           playTone(freq, 'sine', 0.2, time);
        }
        if (state.met) playTone(beatInPhase === 1 ? 1200 : 800, 'square', 0.05, time); 
      }
    }

    function nextBeat() {
      if(state.paused) return; 
      const secondsPerBeat = state.tempo; nextNoteTime += secondsPerBeat; currentBeatIndex++; 
      const totalBeats = state.data.reduce((acc, p) => acc + p.b, 0);
      if (currentBeatIndex >= totalBeats) { currentBeatIndex = 0; state.cyc++; if(state.quotesEnabled) updateQuote(); }
    }
    
    function updateQuote() { const rawQuote = getWuWeiQuote(); els.qt.innerHTML = rawQuote.replace('. ', '.<br>'); }

    function scheduler() {
      if (state.run) {
          if (!state.paused) {
              while (nextNoteTime < audioCtx.currentTime + scheduleAheadTime) { scheduleNote(currentBeatIndex, nextNoteTime); nextBeat(); }
          } else { nextNoteTime = audioCtx.currentTime; }
          scheduleTimerID = setTimeout(scheduler, lookahead);
      }
    }

    function togglePause() {
        if(!state.run) return;
        state.paused = !state.paused;
        if(state.paused) { els.ph.textContent = "PAUSA"; els.ph.style.color = "#78909c"; els.modeIcon.style.opacity = '0.5'; } 
        else { nextNoteTime = audioCtx.currentTime; }
    }

    function draw() {
      if (!state.run) return;
      if(state.paused) { requestAnimationFrame(draw); return; }

      const currentTime = audioCtx.currentTime;
      const elapsed = currentTime - state.startAudioTime;
      const totalCycleDur = state.dur;
      const cycleCountVisual = Math.floor(elapsed / totalCycleDur);
      
      els.cyc.textContent = `üîÑ ${cycleCountVisual}`;
      const timeInCycle = elapsed % totalCycleDur;
      const p = state.data.find(x => timeInCycle >= x.start && timeInCycle < x.end);

      if (p) {
        if (els.ph.textContent !== p.t) { 
            els.ph.textContent = p.t; els.ph.style.color = p.c; 
            const isHold = (p.y === 'hold_high' || p.y === 'hold_low');
            if (isHold) { els.modeIcon.textContent = "‚è∏Ô∏è"; els.modeIcon.classList.add('visible'); } 
            else { els.modeIcon.textContent = (p.m === 'mouth') ? "üå¨Ô∏è" : "üëÉ"; els.modeIcon.classList.add('visible'); }
        }
        els.sph.style.setProperty('--c-phase', p.c);
        
        const currentPhaseIdx = state.data.indexOf(p);
        state.data.forEach((_, idx) => {
            const el = document.getElementById(`p-step-${idx}`);
            if(el) { (idx === currentPhaseIdx) ? el.classList.add('active') : el.classList.remove('active'); }
        });

        const timeInPhase = timeInCycle - p.start;
        let currentBeat = Math.floor(timeInPhase / state.tempo) + 1;
        currentBeat = Math.min(currentBeat, p.b);
        els.cnt.textContent = currentBeat;

        const progress = timeInPhase / p.dur; 
        const ease = -(Math.cos(Math.PI * progress) - 1) / 2;
        let maxScale = (window.innerWidth < 400) ? 1.35 : 1.45; 
        let rawScale = 1;
        if (p.y === 'rise') rawScale = 0.8 + ((maxScale - 0.8) * ease); 
        else if (p.y === 'fall') rawScale = maxScale - ((maxScale - 0.8) * ease);
        else if (p.y === 'hold_high') rawScale = maxScale; 
        else rawScale = 0.8;
        
        els.sph.style.transform = `scale(${rawScale})`;
      }

      const w = els.cvs.width / (window.devicePixelRatio||1);
      const h = els.cvs.height / (window.devicePixelRatio||1);
      els.ctx.clearRect(0, 0, w, h);
      const centerX = w / 2; const trackY = h / 2; const trackH = 14; 
      const pxPerSec = w / (7 * state.tempo);

      for (let c = cycleCountVisual - 1; c <= cycleCountVisual + 1; c++) {
          const cycleStartTime = c * totalCycleDur;
          state.data.forEach(phase => {
              const pStartAbs = cycleStartTime + phase.start;
              const pEndAbs = cycleStartTime + phase.end;
              const xStart = centerX + (pStartAbs - elapsed) * pxPerSec;
              const xEnd = centerX + (pEndAbs - elapsed) * pxPerSec;
              if(xEnd < 0 || xStart > w) return;
              els.ctx.fillStyle = phase.c;
              els.ctx.fillRect(xStart, trackY - trackH/2, xEnd - xStart, trackH);
              els.ctx.strokeStyle = 'rgba(255,255,255,0.9)'; els.ctx.lineWidth = 2;
              for(let b = 0; b <= phase.b; b++) {
                   const beatTimeAbs = pStartAbs + (b * state.tempo);
                   const markX = centerX + (beatTimeAbs - elapsed) * pxPerSec;
                   els.ctx.beginPath(); els.ctx.moveTo(markX, trackY - trackH - 2); els.ctx.lineTo(markX, trackY + trackH + 2); els.ctx.stroke();
              }
          });
      }
      els.ctx.beginPath(); els.ctx.fillStyle = '#FFFFFF'; els.ctx.arc(centerX, trackY, 9, 0, Math.PI * 2); els.ctx.fill();
      els.ctx.strokeStyle = 'rgba(0,0,0,0.1)'; els.ctx.lineWidth = 1; els.ctx.stroke();
      els.ctx.beginPath(); els.ctx.fillStyle = '#37474f'; els.ctx.moveTo(centerX - 6, trackY - 25); els.ctx.lineTo(centerX + 6, trackY - 25); els.ctx.lineTo(centerX, trackY - 15); els.ctx.fill();
      requestAnimationFrame(draw);
    }

    function prepareData(k) {
      if(!patterns[k]) return false;
      state.pk = k; state.data = []; let acc = 0;
      patterns[k].forEach(x => { const d = x.b * state.tempo; state.data.push({...x, start:acc, end:acc+d, dur:d}); acc += d; });
      state.dur = acc;
      return true;
    }

    function initCanvas() {
      if(!els.cvs) return; const dpr = window.devicePixelRatio || 1;
      const rect = els.cvs.getBoundingClientRect(); els.cvs.width = rect.width * dpr; els.cvs.height = rect.height * dpr; els.ctx.scale(dpr, dpr);
    }

    function renderPattern(k) {
      if(!patterns[k]) return;
      els.pat.innerHTML = ''; 
      patterns[k].forEach((step, idx) => {
        const numSpan = document.createElement('span');
        numSpan.textContent = step.b;
        if(step.m === 'mouth') { const sub = document.createElement('span'); sub.textContent = 'b'; sub.className = 'p-mode-sub'; numSpan.appendChild(sub); }
        numSpan.className = 'p-num'; numSpan.id = `p-step-${idx}`; els.pat.appendChild(numSpan);
        if (idx < patterns[k].length - 1) { const sep = document.createElement('span'); sep.textContent = '-'; sep.className = 'p-sep'; els.pat.appendChild(sep); }
      });
    }

    function start(k) {
      if (!prepareData(k)) { alert("Error: Patr√≥n no encontrado"); return; }
      if(state.music || state.music === undefined) { ambientAudio.currentTime = 0; ambientAudio.play().catch(e => console.log(e)); }
      initAudio(); renderPattern(k);
      els.menu.style.opacity = '0'; setTimeout(()=>els.menu.style.display='none', 400);
      
      // Actualizamos visualmente los botones al estado actual
      updateButtonState('quoteToggleBtn', state.quotesEnabled);
      updateButtonState('soundBtn', state.snd);
      updateButtonState('metronomeBtn', state.met);
      updateButtonState('btnMusic', state.music);
      if(state.quotesEnabled && els.qt) els.qt.style.opacity = '1';

      setTimeout(() => {
        initCanvas(); state.run = true; state.paused = false;
        state.startAudioTime = audioCtx ? audioCtx.currentTime : 0; nextNoteTime = state.startAudioTime;
        currentBeatIndex = 0; state.cyc = 0; if(audioCtx) scheduler(); requestAnimationFrame(draw);
      }, 100);
    }

    function stop() {
      ambientAudio.pause(); ambientAudio.currentTime = 0;
      state.run = false; clearTimeout(scheduleTimerID);
      els.sph.style.transform = 'scale(0.8)'; els.ph.textContent = "LISTO"; els.ph.style.color = 'var(--accent)';
      els.modeIcon.classList.remove('visible'); els.cnt.textContent = ""; els.cyc.textContent = "üîÑ 0"; els.sph.style.setProperty('--c-phase', '#4CAF50');
      els.menu.style.display = 'flex'; setTimeout(()=>els.menu.style.opacity='1',10);
      els.pat.innerHTML = ''; els.ctx.clearRect(0,0,els.cvs.width,els.cvs.height);
    }

    // --- FUNCIONES BOTONES CORREGIDAS (Sin borrar SVGs) ---
    function updateButtonState(id, isActive) {
        const btn = document.getElementById(id);
        if(btn) { if(isActive) btn.classList.add('active'); else btn.classList.remove('active'); }
    }

    function toggleTempo() { 
      const t = [1.0, 1.5, 2.0]; const idx = t.indexOf(state.tempo); const next = t[(idx+1)%t.length];
      state.tempo = next; 
      const label = next===1.0?'1x':(next===1.5?'Lento':'Zen');
      document.getElementById('tempoBtn').innerText = `‚ö° ${label}`;
      if(state.run) start(state.pk); 
    }

    function toggleSound() { 
      state.snd=!state.snd; 
      updateButtonState('soundBtn', state.snd);
      if(state.snd && state.run) initAudio();
    }

    function toggleMetronome() { 
      state.met=!state.met; 
      updateButtonState('metronomeBtn', state.met);
    }

    function toggleQuotes() {
        state.quotesEnabled = !state.quotesEnabled;
        updateButtonState('quoteToggleBtn', state.quotesEnabled);
        if(els.qt) els.qt.style.opacity = state.quotesEnabled ? '1' : '0';
        if(state.quotesEnabled) updateQuote();
    }

    function toggleMusic() {
        if (typeof state.music === 'undefined') state.music = true;
        state.music = !state.music;
        updateButtonState('btnMusic', state.music);
        if(state.music) { if(state.run) ambientAudio.play(); } 
        else { ambientAudio.pause(); }
    }

    function openShareConfig() {
        let lastP = state.pk; if(lastP && lastP !== 'custom') { els.pillPatternInput.value = lastP; }
        els.shareConfigOverlay.style.display = 'flex'; els.pillPatternInput.focus();
    }

    async function generateShareLink() {
       let pString = els.pillPatternInput.value.trim(); if(!pString) { alert("Falta el patr√≥n."); return; }
       const testP = parsePatternString(pString); if(testP.length < 2) { alert("Patr√≥n inv√°lido. Ej: 4-7-8b"); return; }
       const n = els.pillNameInput.value.trim() || 'Amigo'; const m = els.pillMessageInput.value.trim() || 'Respira conmigo...';
       els.shareConfigOverlay.style.display = 'none'; els.load.style.display = 'flex'; 
       const baseUrl = location.href.split('?')[0];
       const longUrl = `${baseUrl}?p=${encodeURIComponent(pString)}&to=${encodeURIComponent(n)}&msg=${encodeURIComponent(m)}`;
       let finalUrl = longUrl;
       try { const response = await fetch(`https://tinyurl.com/api-create.php?url=${encodeURIComponent(longUrl)}`); if(response.ok) finalUrl = await response.text(); } catch(e) {}
       els.load.style.display = 'none';
       els.shareText.value = `üåø *P√≠ldora de Respiraci√≥n*\n${m}\n\nPrueba este ritmo: ${pString}\n${finalUrl}`;
       els.shareModal.style.display = 'flex';
    }

    function sendWhatsapp() { window.open(`https://wa.me/?text=${encodeURIComponent(els.shareText.value)}`, '_blank'); }
    function copyToClipboard() { els.shareText.select(); els.shareText.setSelectionRange(0, 99999); try { navigator.clipboard.writeText(els.shareText.value).then(() => alert("¬°Copiado!")); } catch(e) { document.execCommand('copy'); alert("¬°Copiado!"); } }
    function closePill() { document.getElementById('pillOverlay').style.display='none'; }

    const q = new URLSearchParams(location.search);
    if(q.get('p')) {
        let pCode = q.get('p'); const dynamicP = parsePatternString(pCode);
        if(dynamicP.length >= 2) {
           patterns[pCode] = dynamicP; document.getElementById('pillOverlay').style.display = 'flex';
           const recipient = q.get('to') || q.get('para') || 'Ti';
           document.getElementById('pillRecipient').textContent = `Hola, ${recipient}`;
           document.getElementById('pillMessage').textContent = `"${q.get('msg')}"`;
           els.menu.style.display = 'none'; 
           window.closePill = () => { document.getElementById('pillOverlay').style.display='none'; start(pCode); };
        }
    } else { prepareData('4-7-8b'); els.pat.textContent = "4-7-8b"; }
    
    window.addEventListener('resize', () => { if(state.run) initCanvas(); });
    initCanvas();

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js').then((reg) => console.log('Service Worker registrado:', reg.scope)).catch((err) => console.log('Error al registrar SW:', err)); });
    }
  </script>
</body>
</html>
